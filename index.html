<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>IP hlídač</title>
  <link rel="manifest" href="manifest.json">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .days-green {
      color: green;
      font-weight: bold;
    }
    .days-orange {
      color: orange;
      font-weight: bold;
    }
    .days-red {
      color: red;
      font-weight: bold;
    }
    /* Tmavý režim */
    body.dark-mode {
      background: #333;
      color: #eee;
    }
    body.dark-mode .card,
    body.dark-mode .list-group-item,
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode .modal-content {
      background: #444;
      color: #eee;
      border-color: #555;
    }
    /* Styl pro grafický kalendář */
    #graphicalCalendarModal .modal-body table {
      width: 100%;
    }
    #graphicalCalendarModal .modal-body table th, 
    #graphicalCalendarModal .modal-body table td {
      text-align: center;
      vertical-align: top;
      height: 100px;
    }
    /* Styl toolbaru pro rich text editaci */
    .toolbar button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hlavička a tlačítka pro tmavý režim a přizpůsobitelná tlačítka -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">IP hlídač</h1>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="toggleDarkMode()">Tmavý režim</button>
        <span id="customButtonsContainer"></span>
      </div>
    </div>
    <p id="todayDate" class="mb-4"></p>
    
    <!-- Souhrn -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Přehled</h5>
        <p id="summaryText"></p>
      </div>
    </div>
    
    <!-- Lišta klientů (zobrazí se pouze pokud jsou klienti) -->
    <div id="clientButtonsContainer" class="mb-4"></div>
    
    <!-- Úkoly k vyřízení -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Úkoly k vyřízení</h5>
        <div id="tasksList"></div>
      </div>
    </div>
    
    <!-- Nová sekce Kalendář -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Kalendář</h5>
        <div id="calendarList"></div>
        <form id="calendarForm" onsubmit="addCalendarEvent(event)">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Název události:</label>
            <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
            <label for="eventDate" class="form-label">Datum:</label>
            <input type="date" class="form-control" id="eventDate" required>
          </div>
          <div class="mb-3">
            <label for="eventDetails" class="form-label">Detail události:</label>
            <textarea class="form-control" id="eventDetails"></textarea>
          </div>
          <div class="mb-3">
            <label for="eventClientSelect" class="form-label">Přiřadit klienta:</label>
            <select id="eventClientSelect" class="form-select">
              <option value="">-- Nezařadit --</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success">Přidat událost</button>
        </form>
      </div>
    </div>
    
    <!-- Export/Import, Nastavení a Grafický kalendář -->
    <div class="mb-4">
      <button class="btn btn-primary" onclick="exportDataAsFile()">Export dat</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import dat</button>
      <button class="btn btn-secondary" onclick="showSettings()">Nastavení</button>
      <button class="btn btn-info" onclick="showGraphicalCalendar()">Grafický kalendář</button>
      <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    
    <!-- Formulář pro přidání nového klienta -->
    <div class="card mb-4">
      <div class="card-header">
        Přidat nového klienta
      </div>
      <div class="card-body">
        <form id="clientForm" onsubmit="addClient(event)">
          <div class="mb-3">
            <label for="clientName" class="form-label">Jméno klienta:</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="mb-3">
            <label for="clientBirthdate" class="form-label">Datum narození:</label>
            <input type="date" class="form-control" id="clientBirthdate" required>
          </div>
          <button type="submit" class="btn btn-success">Přidat klienta</button>
        </form>
      </div>
    </div>
    
    <!-- Vyhledávání klientů -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Hledat klienta podle jména" onkeyup="filterClients()">
    </div>
    
    <!-- Globální přepínač pro skrytí hotových položek -->
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="hideCompleted" onchange="renderClients()">
      <label class="form-check-label" for="hideCompleted">Skrýt hotové položky</label>
    </div>
    
    <!-- Seznam klientů -->
    <div id="clientsList"></div>
    
    <!-- Footer s informací o verzi -->
    <footer class="text-center mt-5">
      <small>Program vytvořil Přemysl Pozděna, verze 1.0.4.</small>
    </footer>
  </div>
  
  <!-- Modály -->
  <!-- Nastavení modal -->
  <div class="modal" tabindex="-1" id="settingsModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nastavení</h5>
          <button type="button" class="btn-close" onclick="hideSettings()"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" onsubmit="saveSettingsForm(event)">
            <div class="mb-3">
              <label for="settingsEvalThreshold" class="form-label">Prahová hodnota pro hodnocení (dny):</label>
              <input type="number" class="form-control" id="settingsEvalThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsPlanThreshold" class="form-label">Prahová hodnota pro plány (dny):</label>
              <input type="number" class="form-control" id="settingsPlanThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsStepThreshold" class="form-label">Prahová hodnota pro kroky (dny):</label>
              <input type="number" class="form-control" id="settingsStepThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsContractThreshold" class="form-label">Prahová hodnota pro smlouvy (dny):</label>
              <input type="number" class="form-control" id="settingsContractThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsCalendarThreshold" class="form-label">Zobrazovat úkoly z kalendáře, pokud událost končí za (dny):</label>
              <input type="number" class="form-control" id="settingsCalendarThreshold" min="1" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="settingsEnableNotifications">
              <label class="form-check-label" for="settingsEnableNotifications">Povolit notifikace</label>
            </div>
            <div class="mb-3">
              <label for="settingsNotificationInterval" class="form-label">Interval kontroly notifikací (minuty):</label>
              <input type="number" class="form-control" id="settingsNotificationInterval" min="1" required>
            </div>
            <!-- Sekce pro přizpůsobitelná tlačítka -->
            <fieldset class="border p-2 mb-3">
              <legend class="w-auto">Přizpůsobitelná tlačítka</legend>
              <div id="customButtonsConfig"></div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addCustomButtonConfig()">Přidat tlačítko</button>
              <p class="form-text">Maximálně 5 tlačítek. Pokud není provedeno nastavení, zobrazí se výchozí tlačítko.</p>
            </fieldset>
            <button type="submit" class="btn btn-primary">Uložit nastavení</button>
            <button type="button" class="btn btn-danger" onclick="resetData()">Resetovat data</button>
            <button type="button" class="btn btn-warning" onclick="clearCompleted()">Vyčistit hotové položky</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace plánu modal -->
  <div class="modal" tabindex="-1" id="editPlanModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit plán</h5>
          <button type="button" class="btn-close" onclick="hideEditPlanModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editPlanForm" onsubmit="savePlanEdits(event)">
            <div class="mb-3">
              <label for="editPlanName" class="form-label">Název plánu:</label>
              <input type="text" class="form-control" id="editPlanName" required>
            </div>
            <div class="mb-3">
              <label for="editPlanNotes" class="form-label">Poznámky:</label>
              <textarea class="form-control" id="editPlanNotes"></textarea>
            </div>
            <div class="mb-3">
              <label for="editPlanExpiration" class="form-label">Platnost do:</label>
              <input type="date" class="form-control" id="editPlanExpiration" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="editPlanCompleted">
              <label class="form-check-label" for="editPlanCompleted">Hotový</label>
            </div>
            <input type="hidden" id="editPlanClientId">
            <input type="hidden" id="editPlanId">
            <button type="submit" class="btn btn-primary">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace kroku modal -->
  <div class="modal" tabindex="-1" id="editStepModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit krok</h5>
          <button type="button" class="btn-close" onclick="hideEditStepModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editStepForm" onsubmit="saveStepEdits(event)">
            <div class="mb-3">
              <label for="editStepDescription" class="form-label">Popis kroku:</label>
              <input type="text" class="form-control" id="editStepDescription" required>
            </div>
            <div class="mb-3">
              <label for="editStepDate" class="form-label">Datum:</label>
              <input type="date" class="form-control" id="editStepDate" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="editStepCompleted">
              <label class="form-check-label" for="editStepCompleted">Hotový</label>
            </div>
            <input type="hidden" id="editStepClientId">
            <input type="hidden" id="editStepPlanId">
            <input type="hidden" id="editStepId">
            <button type="submit" class="btn btn-primary">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace smlouvy modal -->
  <div class="modal" tabindex="-1" id="editContractModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit smlouvu</h5>
          <button type="button" class="btn-close" onclick="hideEditContractModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editContractForm" onsubmit="saveContractEdits(event)">
            <div class="mb-3">
              <label for="editContractStart" class="form-label">Datum smlouvy (začátek):</label>
              <input type="date" class="form-control" id="editContractStart" required>
            </div>
            <div class="mb-3">
              <label for="editContractExpiration" class="form-label">Platnost do:</label>
              <input type="date" class="form-control" id="editContractExpiration" required>
            </div>
            <input type="hidden" id="editContractClientId">
            <button type="submit" class="btn btn-primary">Uložit smlouvu</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace kalendářní události modal -->
  <div class="modal" tabindex="-1" id="editCalendarModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit událost</h5>
          <button type="button" class="btn-close" onclick="hideEditCalendarModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editCalendarForm" onsubmit="saveCalendarEventEdits(event)">
            <div class="mb-3">
              <label for="editCalendarTitle" class="form-label">Název události:</label>
              <input type="text" class="form-control" id="editCalendarTitle" required>
            </div>
            <div class="mb-3">
              <label for="editCalendarDate" class="form-label">Datum:</label>
              <input type="date" class="form-control" id="editCalendarDate" required>
            </div>
            <div class="mb-3">
              <label for="editCalendarDetails" class="form-label">Detail události:</label>
              <textarea class="form-control" id="editCalendarDetails"></textarea>
            </div>
            <input type="hidden" id="editCalendarId">
            <button type="submit" class="btn btn-primary">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Grafický kalendář modal -->
  <div class="modal" tabindex="-1" id="graphicalCalendarModal">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Grafický kalendář</h5>
          <button type="button" class="btn-close" onclick="hideGraphicalCalendar()"></button>
        </div>
        <div class="modal-body" id="graphicalCalendarBody">
          <!-- Dynamicky generovaný obsah kalendáře -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal: Detaily klienta -->
  <div class="modal" tabindex="-1" id="clientDetailsModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clientDetailsTitle">Detaily klienta</h5>
          <button type="button" class="btn-close" onclick="closeClientDetailsModal()"></button>
        </div>
        <div class="modal-body">
          <div id="clientInfoSection">
            <p id="clientBirthdate"></p>
            <p id="clientEvaluation"></p>
          </div>
          <hr>
          <div id="clientTasksSection">
            <h6>Úkoly klienta</h6>
            <ul id="clientTasksList" class="list-group"></ul>
          </div>
          <hr>
          <div id="clientNotesSection">
            <h6>Poznámky</h6>
            <div class="toolbar mb-2">
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('bold')">B</button>
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('italic')">I</button>
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('underline')">U</button>
            </div>
            <div id="clientNotes" contenteditable="true" style="border: 1px solid #ccc; padding: 10px; min-height: 100px;"></div>
          </div>
          <hr>
          <div id="clientOtherSection">
            <h6>Ostatní</h6>
            <div class="toolbar mb-2">
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('bold')">B</button>
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('italic')">I</button>
              <button type="button" class="btn btn-sm btn-light" onclick="execCmd('underline')">U</button>
            </div>
            <div id="clientOther" contenteditable="true" style="border: 1px solid #ccc; padding: 10px; min-height: 100px;"></div>
          </div>
          <hr>
          <div id="clientCheckboxesSection">
            <h6>Úkoly (checkboxy)</h6>
            <div id="clientCheckboxesList"></div>
            <div class="input-group mt-2">
              <input type="text" id="newCheckboxLabel" class="form-control" placeholder="Název checkboxu">
              <button class="btn btn-secondary" onclick="addClientCheckbox()">Přidat checkbox</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveClientDetails()">Uložit</button>
          <button class="btn btn-secondary" onclick="closeClientDetailsModal()">Zpět do dashboardu</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* Datový model:
       Klient: { id, name, birthdate, lastEvaluation, contractStart, contractExpiration, detailsVisible, plans: [], notes, other, checkboxes: [] }
       Plán: { id, name, notes, expirationDate, completed, steps: [] }
       Krok: { id, description, date, completed }
       Událost: { id, title, date, details, clientId (volitelně) }
    */
    let clients = [];
    let calendarEvents = [];
    // Původní nastavení prahových hodnot
    const defaultSettings = {
      evalThreshold: 7,
      planThreshold: 7,
      stepThreshold: 7,
      contractThreshold: 60,
      calendarThreshold: 3,
      notificationsEnabled: false,
      notificationInterval: 5,
      customButtons: [
        {
          name: "eQuip",
          bgColor: "blue",
          textColor: "white",
          url: "https://e-quip.cz/"
        }
      ]
    };
    let settings = {};
    const appVersion = "1.0.4";
    
    let currentWeekStart = getStartOfWeek(new Date());
    let currentClientId = null; // pro modal s detaily klienta
    
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadSettings();
      loadCalendarEvents();
      updateToday();
      renderClients();
      renderSummary();
      renderTasks();
      renderCalendar();
      updateEventClientSelect();
      renderClientButtons();
      renderCustomButtons();
      loadDarkMode();
      registerServiceWorker();
      if (settings.notificationsEnabled) {
        requestNotificationPermission();
        setInterval(checkNotifications, settings.notificationInterval * 60 * 1000);
      }
    });
    
    function updateToday() {
      const today = new Date();
      document.getElementById('todayDate').textContent = 'Dnes je: ' + today.toLocaleDateString();
    }
    
    // Export dat jako soubor
    function exportDataAsFile() {
      const data = { clients, calendarEvents, settings };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ipHlidac_data.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function importData(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.clients && Array.isArray(importedData.clients)) {
              clients = importedData.clients;
              clients.forEach(client => {
                if (typeof client.detailsVisible === 'undefined') client.detailsVisible = false;
              });
            }
            if (importedData.calendarEvents && Array.isArray(importedData.calendarEvents)) {
              calendarEvents = importedData.calendarEvents;
            }
            if (importedData.settings) {
              settings = importedData.settings;
            }
            saveData();
            saveCalendarEvents();
            renderClients();
            renderSummary();
            renderTasks();
            renderCalendar();
            updateEventClientSelect();
            renderClientButtons();
            renderCustomButtons();
            alert('Data byla úspěšně importována.');
          } catch (error) {
            alert('Chyba při importu dat.');
          }
        };
        reader.readAsText(file);
      }
    }
    
    function loadData() {
      const data = localStorage.getItem('ipHlidacData');
      if (data) {
        clients = JSON.parse(data);
        clients.forEach(client => {
          if (typeof client.detailsVisible === 'undefined') {
            client.detailsVisible = false;
          }
        });
      }
    }
    
    function saveData() {
      localStorage.setItem('ipHlidacData', JSON.stringify(clients));
    }
    
    function loadCalendarEvents() {
      const data = localStorage.getItem('ipHlidacCalendar');
      if (data) {
        calendarEvents = JSON.parse(data);
      }
    }
    
    function saveCalendarEvents() {
      localStorage.setItem('ipHlidacCalendar', JSON.stringify(calendarEvents));
    }
    
    function loadSettings() {
      const data = localStorage.getItem('ipHlidacSettings');
      if (data) {
        settings = JSON.parse(data);
      } else {
        settings = { ...defaultSettings };
      }
      // Ensure customButtons exists
      if (!settings.customButtons) {
        settings.customButtons = defaultSettings.customButtons;
      }
    }
    
    function saveSettings() {
      localStorage.setItem('ipHlidacSettings', JSON.stringify(settings));
    }
    
    function renderSummary() {
      let total = clients.length;
      let overdueEval = 0;
      let expiringPlans = 0;
      let expiringContracts = 0;
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft < 0) overdueEval++;
        } else {
          overdueEval++;
        }
        if (client.plans) {
          client.plans.forEach(plan => {
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            if (daysLeft <= settings.planThreshold) expiringPlans++;
          });
        }
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) expiringContracts++;
        }
      });
      document.getElementById('summaryText').textContent =
        `Celkem klientů: ${total} | Hodnocení k aktualizaci: ${overdueEval} | Plány k aktualizaci: ${expiringPlans} | Smlouvy k obnovení: ${expiringContracts}`;
    }
    
    // Upravená verze renderTasks s úpravou zobrazení kroků
    function renderTasks() {
      let tasks = [];
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasks.push(`Hodnocení u klienta ${client.name} končí za <span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>`);
          }
        } else {
          tasks.push(`U klienta ${client.name} chybí půlroční hodnocení`);
        }
        if (client.plans && client.plans.length > 0) {
          client.plans.forEach(plan => {
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            if (!plan.completed && daysLeft <= settings.planThreshold) {
              tasks.push(`Plán "${plan.name}" u klienta ${client.name} končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>`);
            }
            if (plan.steps) {
              plan.steps.forEach(step => {
                const daysLeftStep = calculateDaysLeft(step.date);
                if (daysLeftStep <= settings.stepThreshold) {
                  let taskText = `Krok "${step.description}" u plánu "${plan.name}" (klient ${client.name}) končí za <span class="${getDaysClass(daysLeftStep)}">${daysLeftStep} dní</span>`;
                  // Pokud má klient individuální plán, zobrazíme i hotové kroky
                  if (client.plans.length > 0 && step.completed) {
                    taskText += " (hotový)";
                  }
                  tasks.push(taskText);
                }
              });
            }
          });
        } else {
          tasks.push(`<span style="color:red; font-weight:bold;">Klient ${client.name} nemá individuální plán.</span>`);
        }
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasks.push(`Smlouva u klienta ${client.name} končí za <span class="${getDaysClass(contractDaysLeft)}">${contractDaysLeft} dní</span>`);
          }
        } else {
          tasks.push(`U klienta ${client.name} není nastavena smlouva`);
        }
      });
      calendarEvents.forEach(event => {
        const daysLeft = calculateDaysLeft(event.date);
        if (daysLeft <= settings.calendarThreshold) {
          tasks.push(`Událost "${event.title}" končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>`);
        }
      });
      let tasksHTML = "";
      if (tasks.length === 0) {
        tasksHTML = "<p>Žádné úkoly k vyřízení.</p>";
      } else {
        tasksHTML = "<ul class='list-group'>";
        tasks.forEach(task => {
          tasksHTML += `<li class="list-group-item">${task}</li>`;
        });
        tasksHTML += "</ul>";
      }
      document.getElementById('tasksList').innerHTML = tasksHTML;
    }
    
    function renderCalendar() {
      let html = "";
      if (calendarEvents.length === 0) {
        html = "<p>Žádné události zatím nebyly přidány.</p>";
      } else {
        html = "<ul class='list-group'>";
        calendarEvents.forEach(event => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                     ${event.title} - ${new Date(event.date).toLocaleDateString()}`;
          if (event.clientId) {
            const client = clients.find(c => c.id === event.clientId);
            if (client) {
              html += ` - Klient: ${client.name}`;
            }
          }
          html += `<div>
                     <button class="btn btn-sm btn-secondary" onclick="editCalendarEvent('${event.id}')">Upravit</button>
                     <button class="btn btn-sm btn-danger" onclick="deleteCalendarEvent('${event.id}')">X</button>
                   </div>
                   </li>`;
        });
        html += "</ul>";
      }
      document.getElementById('calendarList').innerHTML = html;
    }
    
    function addCalendarEvent(e) {
      e.preventDefault();
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const details = document.getElementById('eventDetails').value.trim();
      if (title && date) {
        const newEvent = {
          id: generateId(),
          title: title,
          date: date,
          details: details
        };
        const clientSelect = document.getElementById('eventClientSelect');
        const selectedClient = clientSelect.value;
        if (selectedClient) {
          newEvent.clientId = selectedClient;
        }
        calendarEvents.push(newEvent);
        saveCalendarEvents();
        renderCalendar();
        renderTasks();
        document.getElementById('calendarForm').reset();
        updateEventClientSelect();
      }
    }
    
    function deleteCalendarEvent(eventId) {
      calendarEvents = calendarEvents.filter(ev => ev.id !== eventId);
      saveCalendarEvents();
      renderCalendar();
      renderTasks();
    }
    
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function addClient(event) {
      event.preventDefault();
      const name = document.getElementById('clientName').value.trim();
      const birthdate = document.getElementById('clientBirthdate').value;
      if (name && birthdate) {
        const newClient = {
          id: generateId(),
          name: name,
          birthdate: birthdate,
          lastEvaluation: null,
          contractStart: null,
          contractExpiration: null,
          detailsVisible: false,
          plans: [],
          notes: "",
          other: "",
          checkboxes: []
        };
        clients.push(newClient);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        renderClientButtons();
        updateEventClientSelect();
        document.getElementById('clientForm').reset();
      }
    }
    
    function deleteClient(clientId) {
      if (confirm('Opravdu chceš odstranit tohoto klienta?')) {
        clients = clients.filter(client => client.id !== clientId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        renderClientButtons();
        updateEventClientSelect();
      }
    }
    
    function updateEvaluation(event, clientId) {
      event.preventDefault();
      const input = document.getElementById('eval_' + clientId);
      const client = clients.find(c => c.id === clientId);
      if (client && input.value) {
        client.lastEvaluation = input.value;
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        input.value = "";
      }
    }
    
    function addPlan(event, clientId) {
      event.preventDefault();
      const form = event.target;
      const planName = form.elements['planName'].value.trim();
      const planNotes = form.elements['planNotes'].value.trim();
      const planExpiration = form.elements['planExpiration'].value;
      if (planName && planExpiration) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const newPlan = {
            id: generateId(),
            name: planName,
            notes: planNotes,
            expirationDate: planExpiration,
            completed: false,
            steps: []
          };
          client.plans.push(newPlan);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
          form.reset();
        }
      }
    }
    
    function deletePlan(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.plans = client.plans.filter(plan => plan.id !== planId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    function addStep(event, clientId, planId) {
      event.preventDefault();
      const form = event.target;
      const stepDesc = form.elements['stepDesc'].value.trim();
      const stepDate = form.elements['stepDate'].value;
      if (stepDesc && stepDate) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const plan = client.plans.find(p => p.id === planId);
          if (plan) {
            const newStep = {
              id: generateId(),
              description: stepDesc,
              date: stepDate,
              completed: false
            };
            plan.steps.push(newStep);
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
            form.reset();
          }
        }
      }
    }
    
    function deleteStep(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.steps = plan.steps.filter(step => step.id !== stepId);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    function togglePlanCompletion(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.completed = !plan.completed;
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    function toggleStepCompletion(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            step.completed = !step.completed;
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
          }
        }
      }
    }
    
    function toggleClientDetails(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.detailsVisible = !client.detailsVisible;
        saveData();
        renderClients();
      }
    }
    
    function filterClients() {
      renderClients();
    }
    
    function renderClients() {
      const container = document.getElementById('clientsList');
      container.innerHTML = "";
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const hideCompleted = document.getElementById('hideCompleted').checked;
      if (clients.length === 0) {
        container.innerHTML = "<p>Žádní klienti zatím nejsou přidáni.</p>";
        return;
      }
      clients.forEach(client => {
        if (searchQuery && !client.name.toLowerCase().includes(searchQuery)) return;
        const clientCard = document.createElement('div');
        clientCard.className = "card mb-4";
        let clientHTML = `
          <div class="card-header">
            <strong>${client.name}</strong> (Narozen: ${new Date(client.birthdate).toLocaleDateString()})
            <div class="float-end">
              <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">Odstranit klienta</button>
              <button class="btn btn-sm btn-info" onclick="toggleClientDetails('${client.id}')">
                ${client.detailsVisible ? 'Skrýt detaily' : 'Zobrazit detaily'}
              </button>
            </div>
          </div>
          <div class="collapse ${client.detailsVisible ? 'show' : ''}" id="collapseClient_${client.id}">
            <div class="card-body">
              <div class="mb-3">
                <h6>Půlroční hodnocení:</h6>`;
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          clientHTML += `<p>Poslední: ${new Date(client.lastEvaluation).toLocaleDateString()} | Další: ${evalInfo.nextEvaluation.toLocaleDateString()} (<span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>)</p>`;
        } else {
          clientHTML += `<p>Zatím nebylo provedeno žádné hodnocení.</p>`;
        }
        clientHTML += `
                <form class="mb-3" onsubmit="updateEvaluation(event, '${client.id}')">
                  <div class="mb-2">
                    <input type="date" id="eval_${client.id}" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-sm btn-primary">Nastavit/Aktualizovat hodnocení</button>
                </form>
              </div>
              <div class="mb-3">
                <h6>Smlouva:</h6>`;
        if (client.contractStart && client.contractExpiration) {
          clientHTML += `<p>Od: ${new Date(client.contractStart).toLocaleDateString()} do: ${new Date(client.contractExpiration).toLocaleDateString()}</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Upravit smlouvu</button>`;
        } else {
          clientHTML += `<p>Smlouva není nastavena.</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Přidat smlouvu</button>`;
        }
        clientHTML += `</div>
              <div class="mb-3">
                <h5>Individuální plány:</h5>`;
        if (client.plans.length === 0) {
          clientHTML += `<p>Žádné plány zatím nebyly přidány.</p>`;
        } else {
          client.plans.forEach(plan => {
            if (hideCompleted && plan.completed) return;
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            clientHTML += `
              <div class="card mb-3">
                <div class="card-header">
                  <strong>${plan.name}</strong> - Platnost do: ${new Date(plan.expirationDate).toLocaleDateString()} (<span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>)
                  ${plan.completed ? '<span class="badge bg-success">Hotový</span>' : ''}
                  <div class="float-end">
                    <button class="btn btn-sm btn-warning" onclick="togglePlanCompletion('${client.id}', '${plan.id}')">
                      ${plan.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editPlan('${client.id}', '${plan.id}')">Upravit</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePlan('${client.id}', '${plan.id}')">Odstranit</button>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlan_${client.id}_${plan.id}" aria-expanded="false" aria-controls="collapsePlan_${client.id}_${plan.id}">Zobrazit kroky</button>
                  </div>
                </div>
                <div class="collapse" id="collapsePlan_${client.id}_${plan.id}">
                  <div class="card-body">
                    <p><strong>Poznámky:</strong> ${plan.notes || 'žádné'}</p>`;
            if (plan.steps.length === 0) {
              clientHTML += `<p>Žádné kroky ještě nebyly přidány.</p>`;
            } else {
              clientHTML += `<ul class="list-group mb-2">`;
              plan.steps.forEach(step => {
                if (hideCompleted && step.completed) return;
                const daysLeftStep = calculateDaysLeft(step.date);
                let stepText = `${step.description} - ${new Date(step.date).toLocaleDateString()}`;
                if (client.plans.length > 0 && step.completed) {
                  stepText += " (hotový)";
                }
                clientHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${stepText}
                                <div>
                                  <button class="btn btn-sm btn-warning" onclick="toggleStepCompletion('${client.id}', '${plan.id}', '${step.id}')">
                                    ${step.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                                  </button>
                                  <button class="btn btn-sm btn-secondary" onclick="editStep('${client.id}', '${plan.id}', '${step.id}')">Upravit</button>
                                  <button class="btn btn-sm btn-danger" onclick="deleteStep('${client.id}', '${plan.id}', '${step.id}')">X</button>
                                </div>
                              </li>`;
              });
              clientHTML += `</ul>`;
            }
            clientHTML += `
                    <form onsubmit="addStep(event, '${client.id}', '${plan.id}')">
                      <div class="mb-2">
                        <input type="text" name="stepDesc" class="form-control" placeholder="Popis kroku" required>
                      </div>
                      <div class="mb-2">
                        <input type="date" name="stepDate" class="form-control" required>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Přidat krok</button>
                    </form>
                  </div>
                </div>
              </div>`;
          });
        }
        clientHTML += `
                <div class="mb-3">
                  <h5>Přidat individuální plán:</h5>
                  <form onsubmit="addPlan(event, '${client.id}')">
                    <div class="mb-2">
                      <input type="text" name="planName" class="form-control" placeholder="Název plánu" required>
                    </div>
                    <div class="mb-2">
                      <textarea name="planNotes" class="form-control" placeholder="Poznámky (volitelné)"></textarea>
                    </div>
                    <div class="mb-2">
                      <label>Platnost do:</label>
                      <input type="date" name="planExpiration" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-success">Přidat plán</button>
                  </form>
                </div>
              </div>
            </div>`;
        clientCard.innerHTML = clientHTML;
        container.appendChild(clientCard);
      });
    }
    
    // Modal pro editaci plánu, kroku a smlouvy – funkce zůstávají původní
    function editPlan(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          document.getElementById('editPlanName').value = plan.name;
          document.getElementById('editPlanNotes').value = plan.notes;
          document.getElementById('editPlanExpiration').value = plan.expirationDate;
          document.getElementById('editPlanCompleted').checked = plan.completed;
          document.getElementById('editPlanClientId').value = clientId;
          document.getElementById('editPlanId').value = planId;
          const modal = new bootstrap.Modal(document.getElementById('editPlanModal'));
          modal.show();
        }
      }
    }
    
    function savePlanEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editPlanClientId').value;
      const planId = document.getElementById('editPlanId').value;
      const name = document.getElementById('editPlanName').value.trim();
      const notes = document.getElementById('editPlanNotes').value.trim();
      const expiration = document.getElementById('editPlanExpiration').value;
      const completed = document.getElementById('editPlanCompleted').checked;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.name = name;
          plan.notes = notes;
          plan.expirationDate = expiration;
          plan.completed = completed;
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
      hideEditPlanModal();
    }
    
    function hideEditPlanModal() {
      const modalEl = document.getElementById('editPlanModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function editStep(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            document.getElementById('editStepDescription').value = step.description;
            document.getElementById('editStepDate').value = step.date;
            document.getElementById('editStepCompleted').checked = step.completed;
            document.getElementById('editStepClientId').value = clientId;
            document.getElementById('editStepPlanId').value = planId;
            document.getElementById('editStepId').value = stepId;
            const modal = new bootstrap.Modal(document.getElementById('editStepModal'));
            modal.show();
          }
        }
      }
    }
    
    function saveStepEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editStepClientId').value;
      const planId = document.getElementById('editStepPlanId').value;
      const stepId = document.getElementById('editStepId').value;
      const description = document.getElementById('editStepDescription').value.trim();
      const date = document.getElementById('editStepDate').value;
      const completed = document.getElementById('editStepCompleted').checked;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            step.description = description;
            step.date = date;
            step.completed = completed;
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
          }
        }
      }
      hideEditStepModal();
    }
    
    function hideEditStepModal() {
      const modalEl = document.getElementById('editStepModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function editContract(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        document.getElementById('editContractClientId').value = clientId;
        document.getElementById('editContractStart').value = client.contractStart || "";
        document.getElementById('editContractExpiration').value = client.contractExpiration || "";
        const modal = new bootstrap.Modal(document.getElementById('editContractModal'));
        modal.show();
      }
    }
    
    function saveContractEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editContractClientId').value;
      const start = document.getElementById('editContractStart').value;
      const expiration = document.getElementById('editContractExpiration').value;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.contractStart = start;
        client.contractExpiration = expiration;
        // Automatické nastavení posledního hodnocení, pokud není nastaveno
        if (!client.lastEvaluation && start) {
          client.lastEvaluation = start;
        }
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
      hideEditContractModal();
    }
    
    function hideEditContractModal() {
      const modalEl = document.getElementById('editContractModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function showSettings() {
      document.getElementById('settingsEvalThreshold').value = settings.evalThreshold;
      document.getElementById('settingsPlanThreshold').value = settings.planThreshold;
      document.getElementById('settingsStepThreshold').value = settings.stepThreshold;
      document.getElementById('settingsContractThreshold').value = settings.contractThreshold;
      document.getElementById('settingsCalendarThreshold').value = settings.calendarThreshold;
      document.getElementById('settingsEnableNotifications').checked = settings.notificationsEnabled;
      document.getElementById('settingsNotificationInterval').value = settings.notificationInterval;
      
      // Render custom buttons config v nastavení
      renderCustomButtonsConfig();
      
      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
    }
    
    function hideSettings() {
      const modalEl = document.getElementById('settingsModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function saveSettingsForm(event) {
      event.preventDefault();
      settings.evalThreshold = parseInt(document.getElementById('settingsEvalThreshold').value, 10);
      settings.planThreshold = parseInt(document.getElementById('settingsPlanThreshold').value, 10);
      settings.stepThreshold = parseInt(document.getElementById('settingsStepThreshold').value, 10);
      settings.contractThreshold = parseInt(document.getElementById('settingsContractThreshold').value, 10);
      settings.calendarThreshold = parseInt(document.getElementById('settingsCalendarThreshold').value, 10);
      settings.notificationsEnabled = document.getElementById('settingsEnableNotifications').checked;
      settings.notificationInterval = parseInt(document.getElementById('settingsNotificationInterval').value, 10);
      
      // Uložení konfigurace přizpůsobitelných tlačítek
      const customButtons = [];
      const configContainers = document.querySelectorAll('.custom-button-config');
      configContainers.forEach(container => {
        const name = container.querySelector('.custom-button-name').value.trim();
        const bgColor = container.querySelector('.custom-button-bgcolor').value.trim();
        const textColor = container.querySelector('.custom-button-textcolor').value.trim();
        const url = container.querySelector('.custom-button-url').value.trim();
        if (name && bgColor && textColor && url) {
          customButtons.push({ name, bgColor, textColor, url });
        }
      });
      settings.customButtons = customButtons;
      saveSettings();
      hideSettings();
      renderSummary();
      renderTasks();
      renderCustomButtons();
    }
    
    function clearCompleted() {
      if (confirm("Opravdu chceš odstranit všechny hotové položky? Tato akce je nevratná.")) {
        clients.forEach(client => {
          client.plans = client.plans.filter(plan => {
            if (plan.completed) return false;
            plan.steps = plan.steps.filter(step => !step.completed);
            return true;
          });
        });
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    function resetData() {
      if (confirm("Opravdu chceš smazat VŠECHNA data? Tato akce je nevratná.")) {
        localStorage.removeItem('ipHlidacData');
        localStorage.removeItem('ipHlidacSettings');
        localStorage.removeItem('ipHlidacCalendar');
        location.reload();
      }
    }
    
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'true' : 'false');
    }
    
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
      }
    }
    
    function calculateDaysLeft(expirationDate) {
      const today = new Date();
      const expDate = new Date(expirationDate);
      const diffTime = expDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
    
    function calculateEvalDays(lastEval) {
      const evalDate = new Date(lastEval);
      evalDate.setMonth(evalDate.getMonth() + 6);
      const today = new Date();
      const diffTime = evalDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return { nextEvaluation: evalDate, daysLeft: diffDays };
    }
    
    function getDaysClass(days) {
      if (days > 5) return 'days-green';
      if (days >= 0 && days <= 5) return 'days-orange';
      return 'days-red';
    }
    
    // Service Worker registrace s notifikací nové verze
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => {
            reg.onupdatefound = () => {
              const newWorker = reg.installing;
              newWorker.onstatechange = () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdateModal();
                }
              }
            };
          })
          .catch(err => console.error('Chyba při registraci Service Workeru:', err));
      }
    }
    
    function showUpdateModal() {
      const modal = new bootstrap.Modal(document.getElementById('updateModal'));
      modal.show();
    }
    
    function hideUpdateModal() {
      const modalEl = document.getElementById('updateModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function updateApp() {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (reg && reg.waiting) {
          reg.waiting.postMessage({ action: 'skipWaiting' });
        }
        window.location.reload();
      });
    }
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('Service Worker registrován'))
        .catch(err => console.error('Chyba při registraci Service Workeru:', err));
    }
    
    // Notification API
    function requestNotificationPermission() {
      if ('Notification' in window) {
        if (Notification.permission === 'default') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('Notifikace povoleny');
            }
          });
        }
      }
    }
    
    let notifiedTasks = {};
    
    function checkNotifications() {
      if (!settings.notificationsEnabled) return;
      if (Notification.permission !== 'granted') return;
      let tasksToNotify = [];
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasksToNotify.push({
              id: 'eval_' + client.id,
              message: `Hodnocení u klienta ${client.name} končí za ${evalInfo.daysLeft} dní`
            });
          }
        } else {
          tasksToNotify.push({
            id: 'eval_' + client.id,
            message: `U klienta ${client.name} chybí půlroční hodnocení`
          });
        }
        if (client.plans) {
          client.plans.forEach(plan => {
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            if (!plan.completed && daysLeft <= settings.planThreshold) {
              tasksToNotify.push({
                id: 'plan_' + plan.id,
                message: `Plán "${plan.name}" u klienta ${client.name} končí za ${daysLeft} dní`
              });
            }
            if (plan.steps) {
              plan.steps.forEach(step => {
                const daysLeftStep = calculateDaysLeft(step.date);
                if (daysLeftStep <= settings.stepThreshold) {
                  tasksToNotify.push({
                    id: 'step_' + step.id,
                    message: `Krok "${step.description}" u plánu "${plan.name}" u klienta ${client.name} končí za ${daysLeftStep} dní`
                  });
                }
              });
            }
          });
        }
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasksToNotify.push({
              id: 'contract_' + client.id,
              message: `Smlouva u klienta ${client.name} končí za ${contractDaysLeft} dní`
            });
          }
        } else {
          tasksToNotify.push({
            id: 'contract_' + client.id,
            message: `U klienta ${client.name} není nastavena smlouva`
          });
        }
      });
      calendarEvents.forEach(event => {
        const daysLeft = calculateDaysLeft(event.date);
        if (daysLeft <= settings.calendarThreshold) {
          tasksToNotify.push({
            id: 'calendar_' + event.id,
            message: `Událost "${event.title}" končí za ${daysLeft} dní`
          });
        }
      });
      tasksToNotify.forEach(task => {
        if (!notifiedTasks[task.id] || (Date.now() - notifiedTasks[task.id] > settings.notificationInterval * 60 * 1000)) {
          new Notification('IP Hlídač - Úkol', { body: task.message });
          notifiedTasks[task.id] = Date.now();
        }
      });
    }
    
    // Grafický kalendář – zobrazení celého týdne (pondělí až neděle)
    function getStartOfWeek(date) {
      const day = date.getDay();
      const adjustedDay = (day === 0 ? 7 : day);
      const diff = 1 - adjustedDay;
      const monday = new Date(date);
      monday.setDate(date.getDate() + diff);
      monday.setHours(0,0,0,0);
      return monday;
    }
    
    function showGraphicalCalendar() {
      renderGraphicalCalendar();
      const modal = new bootstrap.Modal(document.getElementById('graphicalCalendarModal'));
      modal.show();
    }
    
    function hideGraphicalCalendar() {
      const modalEl = document.getElementById('graphicalCalendarModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function renderGraphicalCalendar() {
      const modalBody = document.getElementById('graphicalCalendarBody');
      modalBody.innerHTML = "";
      const navDiv = document.createElement('div');
      navDiv.className = "d-flex justify-content-between align-items-center mb-3";
      const prevBtn = document.createElement('button');
      prevBtn.className = "btn btn-secondary";
      prevBtn.textContent = "Předchozí týden";
      prevBtn.onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); renderGraphicalCalendar(); };
      const nextBtn = document.createElement('button');
      nextBtn.className = "btn btn-secondary";
      nextBtn.textContent = "Následující týden";
      nextBtn.onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); renderGraphicalCalendar(); };
      const weekDisplay = document.createElement('div');
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(currentWeekStart.getDate() + 6);
      weekDisplay.textContent = "Týden od " + currentWeekStart.toLocaleDateString() + " do " + weekEnd.toLocaleDateString();
      navDiv.appendChild(prevBtn);
      navDiv.appendChild(weekDisplay);
      navDiv.appendChild(nextBtn);
      modalBody.appendChild(navDiv);
      
      const table = document.createElement('table');
      table.className = "table table-bordered";
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      for (let i = 0; i < 7; i++) {
        const th = document.createElement('th');
        let day = new Date(currentWeekStart);
        day.setDate(currentWeekStart.getDate() + i);
        th.textContent = day.toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'numeric' });
        headerRow.appendChild(th);
      }
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const row = document.createElement('tr');
      for (let i = 0; i < 7; i++) {
        const td = document.createElement('td');
        let day = new Date(currentWeekStart);
        day.setDate(currentWeekStart.getDate() + i);
        let eventsForDay = [];
        calendarEvents.forEach(ev => {
          const eventDate = new Date(ev.date);
          if (eventDate.toDateString() === day.toDateString()) {
            eventsForDay.push({ title: ev.title, id: ev.id, type: 'calendar' });
          }
        });
        clients.forEach(client => {
          if (client.lastEvaluation) {
            const evalInfo = calculateEvalDays(client.lastEvaluation);
            if (new Date(evalInfo.nextEvaluation).toDateString() === day.toDateString()) {
              eventsForDay.push({ title: `Hodnocení: ${client.name}`, id: 'eval_' + client.id, type: 'evaluation' });
            }
          }
          if (client.plans) {
            client.plans.forEach(plan => {
              const planDate = new Date(plan.expirationDate);
              if (planDate.toDateString() === day.toDateString()) {
                eventsForDay.push({ title: `Plán: ${plan.name}`, id: 'plan_' + plan.id, type: 'plan' });
              }
              if (plan.steps) {
                plan.steps.forEach(step => {
                  const stepDate = new Date(step.date);
                  if (stepDate.toDateString() === day.toDateString()) {
                    eventsForDay.push({ title: `Krok: ${step.description}`, id: 'step_' + step.id, type: 'step' });
                  }
                });
              }
            });
          }
          if (client.contractExpiration) {
            const contractDate = new Date(client.contractExpiration);
            if (contractDate.toDateString() === day.toDateString()) {
              eventsForDay.push({ title: `Smlouva: ${client.name}`, id: 'contract_' + client.id, type: 'contract' });
            }
          }
        });
        if (eventsForDay.length > 0) {
          eventsForDay.forEach(ev => {
            const evDiv = document.createElement('div');
            evDiv.style.backgroundColor = ev.type === 'calendar' ? 'blue' : 'gray';
            evDiv.style.color = "white";
            evDiv.style.padding = "2px 4px";
            evDiv.style.marginBottom = "2px";
            evDiv.style.borderRadius = "4px";
            evDiv.style.cursor = (ev.type === 'calendar') ? "pointer" : "default";
            evDiv.textContent = ev.title;
            if (ev.type === 'calendar') {
              evDiv.onclick = () => editCalendarEvent(ev.id);
            }
            td.appendChild(evDiv);
          });
        } else {
          td.textContent = "-";
        }
        row.appendChild(td);
      }
      tbody.appendChild(row);
      table.appendChild(tbody);
      modalBody.appendChild(table);
      
      const exportBtn = document.createElement('button');
      exportBtn.className = "btn btn-success mt-3";
      exportBtn.textContent = "Export pro Google kalendář";
      exportBtn.onclick = exportForGoogleCalendar;
      modalBody.appendChild(exportBtn);
    }
    
    function exportForGoogleCalendar() {
      let csvContent = "Subject,Start Date,Description\n";
      calendarEvents.forEach(ev => {
        csvContent += `"${ev.title}","${new Date(ev.date).toLocaleDateString('en-US')}","${ev.details}"\n`;
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "google_calendar_export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function editCalendarEvent(eventId) {
      const eventObj = calendarEvents.find(ev => ev.id === eventId);
      if (eventObj) {
        document.getElementById('editCalendarTitle').value = eventObj.title;
        document.getElementById('editCalendarDate').value = eventObj.date;
        document.getElementById('editCalendarDetails').value = eventObj.details;
        document.getElementById('editCalendarId').value = eventId;
        const modal = new bootstrap.Modal(document.getElementById('editCalendarModal'));
        modal.show();
      }
    }
    
    // FUNKCE PRO MODAL DETALÍ KLIENTA
    function renderClientButtons() {
      const container = document.getElementById('clientButtonsContainer');
      container.innerHTML = "";
      if (clients.length === 0) return;
      clients.forEach(client => {
        const btn = document.createElement('button');
        btn.className = "btn btn-info me-2";
        btn.textContent = client.name;
        btn.onclick = () => openClientDetailsModal(client.id);
        container.appendChild(btn);
      });
    }
    
    function openClientDetailsModal(clientId) {
      currentClientId = clientId;
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      document.getElementById('clientDetailsTitle').textContent = "Detaily: " + client.name;
      document.getElementById('clientBirthdate').textContent = "Narozen: " + new Date(client.birthdate).toLocaleDateString();
      if (client.lastEvaluation) {
        const evalInfo = calculateEvalDays(client.lastEvaluation);
        document.getElementById('clientEvaluation').innerHTML = `Poslední hodnocení: ${new Date(client.lastEvaluation).toLocaleDateString()} | Další: ${evalInfo.nextEvaluation.toLocaleDateString()} (<span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>)`;
      } else {
        document.getElementById('clientEvaluation').textContent = "Hodnocení nebylo provedeno.";
      }
      document.getElementById('clientNotes').innerHTML = client.notes || "";
      document.getElementById('clientOther').innerHTML = client.other || "";
      if (!client.checkboxes) {
        client.checkboxes = [];
      }
      renderClientCheckboxes(client);
      renderClientTasks(client);
      const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
      modal.show();
    }
    
    function closeClientDetailsModal() {
      const modalEl = document.getElementById('clientDetailsModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function saveClientDetails() {
      const client = clients.find(c => c.id === currentClientId);
      if (!client) return;
      client.notes = document.getElementById('clientNotes').innerHTML;
      client.other = document.getElementById('clientOther').innerHTML;
      saveData();
      renderClients();
      renderClientButtons();
      updateEventClientSelect();
      closeClientDetailsModal();
    }
    
    function renderClientCheckboxes(client) {
      const container = document.getElementById('clientCheckboxesList');
      container.innerHTML = "";
      client.checkboxes.forEach((checkbox, index) => {
        const div = document.createElement('div');
        div.className = "form-check d-flex align-items-center";
        
        const input = document.createElement('input');
        input.type = "checkbox";
        input.className = "form-check-input";
        input.id = `client_${client.id}_checkbox_${index}`;
        input.checked = checkbox.checked;
        input.onchange = function() {
          checkbox.checked = input.checked;
          saveData();
        };
        
        const label = document.createElement('label');
        label.className = "form-check-label";
        label.htmlFor = input.id;
        label.textContent = checkbox.label;
        
        div.appendChild(input);
        div.appendChild(label);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Smazat";
        deleteBtn.className = "btn btn-sm btn-danger ms-2";
        deleteBtn.onclick = function() {
          deleteClientCheckbox(client.id, index);
        };
        div.appendChild(deleteBtn);
        
        container.appendChild(div);
      });
    }
    
    function deleteClientCheckbox(clientId, index) {
      const client = clients.find(c => c.id === clientId);
      if (client && client.checkboxes) {
        client.checkboxes.splice(index, 1);
        saveData();
        renderClientCheckboxes(client);
      }
    }
    
    function addClientCheckbox() {
      const labelInput = document.getElementById('newCheckboxLabel');
      const labelText = labelInput.value.trim();
      if (!labelText) return;
      const client = clients.find(c => c.id === currentClientId);
      if (!client) return;
      if (!client.checkboxes) client.checkboxes = [];
      client.checkboxes.push({ label: labelText, checked: false });
      labelInput.value = "";
      renderClientCheckboxes(client);
      saveData();
    }
    
    function renderClientTasks(client) {
      const tasks = [];
      if (client.lastEvaluation) {
        const evalInfo = calculateEvalDays(client.lastEvaluation);
        if (evalInfo.daysLeft <= settings.evalThreshold) {
          tasks.push(`Hodnocení končí za <span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>`);
        }
      } else {
        tasks.push("Chybí půlroční hodnocení.");
      }
      if (client.plans && client.plans.length > 0) {
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (!plan.completed && daysLeft <= settings.planThreshold) {
            tasks.push(`Plán "${plan.name}" končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>`);
          }
          if (plan.steps) {
            plan.steps.forEach(step => {
              const daysLeftStep = calculateDaysLeft(step.date);
              if (daysLeftStep <= settings.stepThreshold) {
                let stepText = `Krok "${step.description}" končí za <span class="${getDaysClass(daysLeftStep)}">${daysLeftStep} dní</span>`;
                if (client.plans.length > 0 && step.completed) {
                  stepText += " (hotový)";
                }
                tasks.push(stepText);
              }
            });
          }
        });
      }
      if (client.contractExpiration) {
        const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
        if (contractDaysLeft <= settings.contractThreshold) {
          tasks.push(`Smlouva končí za <span class="${getDaysClass(contractDaysLeft)}">${contractDaysLeft} dní</span>`);
        }
      } else {
        tasks.push("Smlouva není nastavena.");
      }
      let tasksHTML = "";
      if (tasks.length === 0) {
        tasksHTML = "<p>Žádné úkoly.</p>";
      } else {
        tasksHTML = "<ul class='list-group'>";
        tasks.forEach(task => {
          tasksHTML += `<li class="list-group-item">${task}</li>`;
        });
        tasksHTML += "</ul>";
      }
      document.getElementById('clientTasksList').innerHTML = tasksHTML;
    }
    
    function updateEventClientSelect() {
      const select = document.getElementById('eventClientSelect');
      select.innerHTML = `<option value="">-- Nezařadit --</option>`;
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        select.appendChild(option);
      });
    }
    
    // Custom Buttons
    function renderCustomButtons() {
      const container = document.getElementById('customButtonsContainer');
      container.innerHTML = "";
      if (settings.customButtons && settings.customButtons.length > 0) {
        settings.customButtons.forEach(btnConfig => {
          const btn = document.createElement('button');
          btn.className = "btn btn-outline-primary me-2";
          btn.textContent = btnConfig.name;
          btn.style.backgroundColor = btnConfig.bgColor;
          btn.style.color = btnConfig.textColor;
          btn.onclick = () => window.open(btnConfig.url, '_blank');
          container.appendChild(btn);
        });
      }
    }
    
    function renderCustomButtonsConfig() {
      const container = document.getElementById('customButtonsConfig');
      container.innerHTML = "";
      if (settings.customButtons && settings.customButtons.length > 0) {
        settings.customButtons.forEach((btnConfig, index) => {
          container.innerHTML += `
            <div class="custom-button-config mb-2" data-index="${index}">
              <label class="form-label">Tlačítko ${index + 1}:</label>
              <input type="text" class="form-control custom-button-name" placeholder="Název tlačítka" value="${btnConfig.name}" required>
              <input type="text" class="form-control custom-button-bgcolor" placeholder="Barva tlačítka" value="${btnConfig.bgColor}" required>
              <input type="text" class="form-control custom-button-textcolor" placeholder="Barva písma" value="${btnConfig.textColor}" required>
              <input type="url" class="form-control custom-button-url" placeholder="URL" value="${btnConfig.url}" required>
              <button type="button" class="btn btn-sm btn-danger mt-1" onclick="removeCustomButtonConfig(${index})">Odstranit tlačítko</button>
              <hr>
            </div>`;
        });
      }
    }
    
    function addCustomButtonConfig() {
      const currentCount = document.querySelectorAll('.custom-button-config').length;
      if (currentCount >= 5) {
        alert("Maximálně 5 tlačítek.");
        return;
      }
      const container = document.getElementById('customButtonsConfig');
      container.innerHTML += `
        <div class="custom-button-config mb-2" data-index="${currentCount}">
          <label class="form-label">Tlačítko ${currentCount + 1}:</label>
          <input type="text" class="form-control custom-button-name" placeholder="Název tlačítka" required>
          <input type="text" class="form-control custom-button-bgcolor" placeholder="Barva tlačítka" required>
          <input type="text" class="form-control custom-button-textcolor" placeholder="Barva písma" required>
          <input type="url" class="form-control custom-button-url" placeholder="URL" required>
          <button type="button" class="btn btn-sm btn-danger mt-1" onclick="removeCustomButtonConfig(${currentCount})">Odstranit tlačítko</button>
          <hr>
        </div>`;
    }
    
    function removeCustomButtonConfig(index) {
      const container = document.getElementById('customButtonsConfig');
      const configs = document.querySelectorAll('.custom-button-config');
      configs[index].remove();
      // Re-index remaining
      document.querySelectorAll('.custom-button-config').forEach((elem, idx) => {
        elem.setAttribute('data-index', idx);
        elem.querySelector('label.form-label').textContent = `Tlačítko ${idx + 1}:`;
      });
    }
    
    // Simple execCmd pro rich text editor v poznámkách klienta
    function execCmd(command) {
      document.execCommand(command, false, null);
    }
  </script>
</body>
</html>
