<!DOCTYPE html>
<html lang="cs">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <title>IP hlídač</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .days-green {
      color: green;
      font-weight: bold;
    }
    .days-orange {
      color: orange;
      font-weight: bold;
    }
    .days-red {
      color: red;
      font-weight: bold;
    }
    /* Tmavý režim */
    body.dark-mode {
      background: #333;
      color: #eee;
    }
    body.dark-mode .card,
    body.dark-mode .list-group-item,
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode .modal-content {
      background: #444;
      color: #eee;
      border-color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hlavička a tlačítko pro tmavý režim -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">IP hlídač</h1>
      <button class="btn btn-outline-secondary" onclick="toggleDarkMode()">Tmavý režim</button>
    </div>
    
    <!-- Datum -->
    <p id="todayDate" class="mb-4"></p>
    
    <!-- Souhrn -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Přehled</h5>
        <p id="summaryText"></p>
      </div>
    </div>
    
    <!-- Úkoly pro vyřízení -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Úkoly pro vyřízení</h5>
        <div id="tasksList"></div>
      </div>
    </div>
    
    <!-- Nová sekce Kalendář -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Kalendář</h5>
        <div id="calendarList"></div>
        <form id="calendarForm" onsubmit="addCalendarEvent(event)">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Název události:</label>
            <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
            <label for="eventDate" class="form-label">Datum:</label>
            <input type="date" class="form-control" id="eventDate" required>
          </div>
          <div class="mb-3">
            <label for="eventDetails" class="form-label">Detail události:</label>
            <textarea class="form-control" id="eventDetails"></textarea>
          </div>
          <button type="submit" class="btn btn-success">Přidat událost</button>
        </form>
      </div>
    </div>
    
    <!-- Export/Import a Nastavení -->
    <div class="mb-4">
      <button class="btn btn-primary" onclick="showExport()">Export dat</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import dat</button>
      <button class="btn btn-secondary" onclick="showSettings()">Nastavení</button>
      <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    
    <!-- Formulář pro přidání nového klienta -->
    <!-- ... původní kód ... -->
    
    <!-- Footer -->
    <footer class="text-center mt-5">
      <small>Program vytvořil Přemysl Pozděna, verze 1.0.1.</small>
    </footer>
  </div>
  
  <!-- Modál pro notifikaci aktualizace -->
  <div class="modal" tabindex="-1" id="updateModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aktualizace k dispozici</h5>
          <button type="button" class="btn-close" onclick="hideUpdateModal()"></button>
        </div>
        <div class="modal-body">
          <p>Nová verze: 1.0.1</p>
          <p>Změny:</p>
          <ul>
            <li>Přidáno barevné označení úkolů</li>
            <li>Přidána notifikace o nové verzi s přehledem změn</li>
            <li>Vylepšen tmavý režim (světlé písmo)</li>
            <li>Přidán kalendář pro schůzky a poznámky</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideUpdateModal()">Zrušit</button>
          <button type="button" class="btn btn-primary" onclick="updateApp()">Aktualizovat</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Ostatní modály (Export, Editace plánu, atd.) -->
  <!-- ... původní kód ... -->
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* Globální proměnné a nastavení */
    let clients = [];
    let calendarEvents = []; // nové pole pro kalendářové události

    const defaultSettings = {
      evalThreshold: 7,
      planThreshold: 7,
      stepThreshold: 7,
      contractThreshold: 60,
      calendarThreshold: 3  // prahová hodnota pro kalendář (v dnech)
    };
    let settings = {};
    const appVersion = "1.0.1";
    const changelog = "• Přidáno barevné označení úkolů\n• Přidána notifikace o nové verzi aplikace\n• Vylepšen tmavý režim (světlé písmo)\n• Přidán kalendář pro schůzky a poznámky";

    /* Původní inicializace a načítání dat */
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadCalendarEvents();
      loadSettings();
      updateToday();
      renderClients();
      renderSummary();
      renderTasks();
      renderCalendar();
      loadDarkMode();
      registerServiceWorker();
    });
    
    /* Funkce pro aktualizaci dnešního data */
    function updateToday() {
      const today = new Date();
      document.getElementById('todayDate').textContent = 'Dnes je: ' + today.toLocaleDateString();
    }
    
    /* --------------------------
       Funkce pro úkoly pro vyřízení
       -------------------------- */
    function getDaysClass(days) {
      if (days > 5) {
        return 'days-green';
      } else if (days >= 0 && days <= 5) {
        return 'days-orange';
      } else {
        return 'days-red';
      }
    }
    
    function renderTasks() {
      let tasks = [];
      // Úkoly z klientů
      clients.forEach(client => {
        // Půlroční hodnocení
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasks.push(`Hodnocení u klienta ${client.name} končí za <span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span> (${evalInfo.daysLeft < 0 ? "POZDE" : "blízko"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} chybí půlroční hodnocení`);
        }
        // Plány
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (!plan.completed && daysLeft <= settings.planThreshold) {
            tasks.push(`Plán "${plan.name}" u klienta ${client.name} končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span> (${daysLeft < 0 ? "POZDE" : "brzy"})`);
          }
          // Kroky
          plan.steps.forEach(step => {
            if (!step.completed) {
              const daysLeftStep = calculateDaysLeft(step.date);
              if (daysLeftStep <= settings.stepThreshold) {
                tasks.push(`Krok "${step.description}" u plánu "${plan.name}" (klient ${client.name}) končí za <span class="${getDaysClass(daysLeftStep)}">${daysLeftStep} dní</span> (${daysLeftStep < 0 ? "POZDE" : "blízko"})`);
              }
            }
          });
        });
        // Smlouvy
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasks.push(`Smlouva u klienta ${client.name} končí za <span class="${getDaysClass(contractDaysLeft)}">${contractDaysLeft} dní</span> (${contractDaysLeft < 0 ? "VYPRŠELA" : "brzy"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} není nastavena smlouva`);
        }
      });
      // Úkoly z kalendáře
      calendarEvents.forEach(event => {
        const daysLeft = calculateDaysLeft(event.date);
        if (daysLeft <= settings.calendarThreshold) {
          tasks.push(`Událost "${event.title}" končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span> (${daysLeft < 0 ? "POZDE" : "blízko"})`);
        }
      });
      let tasksHTML = "";
      if (tasks.length === 0) {
        tasksHTML = "<p>Žádné úkoly k vyřízení.</p>";
      } else {
        tasksHTML = "<ul class='list-group'>";
        tasks.forEach(task => {
          tasksHTML += `<li class="list-group-item">${task}</li>`;
        });
        tasksHTML += "</ul>";
      }
      document.getElementById('tasksList').innerHTML = tasksHTML;
    }
    
    /* --------------------------
       Funkce pro kalendář
       -------------------------- */
    function loadCalendarEvents() {
      const data = localStorage.getItem('ipHlidacCalendar');
      if (data) {
        calendarEvents = JSON.parse(data);
      }
    }
    
    function saveCalendarEvents() {
      localStorage.setItem('ipHlidacCalendar', JSON.stringify(calendarEvents));
    }
    
    function renderCalendar() {
      const container = document.getElementById('calendarList');
      let html = "";
      if (calendarEvents.length === 0) {
        html = "<p>Žádné události zatím nebyly přidány.</p>";
      } else {
        html = "<ul class='list-group'>";
        calendarEvents.forEach(event => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                     ${event.title} - ${new Date(event.date).toLocaleDateString()}
                     <button class="btn btn-sm btn-danger" onclick="deleteCalendarEvent('${event.id}')">X</button>
                   </li>`;
        });
        html += "</ul>";
      }
      container.innerHTML = html;
    }
    
    function addCalendarEvent(e) {
      e.preventDefault();
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const details = document.getElementById('eventDetails').value.trim();
      if (title && date) {
        const newEvent = {
          id: '_' + Math.random().toString(36).substr(2, 9),
          title: title,
          date: date,
          details: details
        };
        calendarEvents.push(newEvent);
        saveCalendarEvents();
        renderCalendar();
        renderTasks();
        document.getElementById('calendarForm').reset();
      }
    }
    
    function deleteCalendarEvent(eventId) {
      calendarEvents = calendarEvents.filter(ev => ev.id !== eventId);
      saveCalendarEvents();
      renderCalendar();
      renderTasks();
    }
    
    /* --------------------------
       Service Worker a aktualizace verze
       -------------------------- */
    let newWorker;
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => {
            reg.onupdatefound = () => {
              newWorker = reg.installing;
              newWorker.onstatechange = () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdateModal();
                }
              }
            };
          })
          .catch(err => console.error('Chyba při registraci Service Workeru:', err));
      }
    }
    
    function showUpdateModal() {
      const modal = new bootstrap.Modal(document.getElementById('updateModal'));
      modal.show();
    }
    
    function hideUpdateModal() {
      const modalEl = document.getElementById('updateModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function updateApp() {
      newWorker.postMessage({ action: 'skipWaiting' });
      // Po aktualizaci reloadneme stránku
      window.location.reload();
    }
    
    /* --------------------------
       Ostatní funkce (loadData, saveData, renderClients, renderSummary, atd.)
       Ponechal/a jsem původní kód s drobnými úpravami tam, kde to souviselo.
       -------------------------- */
    
    // ... zbytek původního kódu (přidání klienta, editace, mazání, nastavení atd.) ...
    
    /* Funkce pro tmavý režim */
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'true' : 'false');
    }
    
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
      }
    }
    
    /* Pomocné funkce pro výpočet dnů */
    function calculateDaysLeft(expirationDate) {
      const today = new Date();
      const expDate = new Date(expirationDate);
      const diffTime = expDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
    
    function calculateEvalDays(lastEval) {
      const evalDate = new Date(lastEval);
      evalDate.setMonth(evalDate.getMonth() + 6);
      const today = new Date();
      const diffTime = evalDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return { nextEvaluation: evalDate, daysLeft: diffDays };
    }
    
    /* Funkce pro načtení a uložení dat klientů */
    function loadData() {
      const data = localStorage.getItem('ipHlidacData');
      if (data) {
        clients = JSON.parse(data);
        clients.forEach(client => {
          if (typeof client.detailsVisible === 'undefined') {
            client.detailsVisible = false;
          }
        });
      }
    }
    
    function saveData() {
      localStorage.setItem('ipHlidacData', JSON.stringify(clients));
    }
    
    // Další původní funkce pro práci s klienty...
    
  </script>
</body>
</html>

