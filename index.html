<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>IP hlídač</title>
  <link rel="manifest" href="manifest.json">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .days-green {
      color: green;
      font-weight: bold;
    }
    .days-orange {
      color: orange;
      font-weight: bold;
    }
    .days-red {
      color: red;
      font-weight: bold;
    }
    /* Tmavý režim */
    body.dark-mode {
      background: #333;
      color: #eee;
    }
    body.dark-mode .card,
    body.dark-mode .list-group-item,
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode .modal-content {
      background: #444;
      color: #eee;
      border-color: #555;
    }
    /* Styl pro FullCalendar uvnitř modálu */
    #calendarView {
      max-height: 500px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hlavička a tlačítko pro tmavý režim + grafický kalendář -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">IP hlídač</h1>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="toggleDarkMode()">Tmavý režim</button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#graphicalCalendarModal">Grafický kalendář</button>
      </div>
    </div>
    <p id="todayDate" class="mb-4"></p>
    
    <!-- Souhrn -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Přehled</h5>
        <p id="summaryText"></p>
      </div>
    </div>
    
    <!-- Úkoly k vyřízení -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Úkoly k vyřízení</h5>
        <div id="tasksList"></div>
      </div>
    </div>
    
    <!-- Sekce Kalendář (textový seznam) -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Kalendář – textový seznam</h5>
        <div id="calendarList"></div>
        <form id="calendarForm" onsubmit="addCalendarEvent(event)">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Název události:</label>
            <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
            <label for="eventDate" class="form-label">Datum:</label>
            <input type="date" class="form-control" id="eventDate" required>
          </div>
          <div class="mb-3">
            <label for="eventDetails" class="form-label">Detail události:</label>
            <textarea class="form-control" id="eventDetails"></textarea>
          </div>
          <button type="submit" class="btn btn-success">Přidat událost</button>
        </form>
      </div>
    </div>
    
    <!-- Export/Import a Nastavení -->
    <div class="mb-4">
      <button class="btn btn-primary" onclick="exportDataDownload()">Export dat</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import dat</button>
      <button class="btn btn-secondary" onclick="showSettings()">Nastavení</button>
      <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    
    <!-- Formulář pro přidání nového klienta -->
    <div class="card mb-4">
      <div class="card-header">
        Přidat nového klienta
      </div>
      <div class="card-body">
        <form id="clientForm" onsubmit="addClient(event)">
          <div class="mb-3">
            <label for="clientName" class="form-label">Jméno klienta:</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="mb-3">
            <label for="clientBirthdate" class="form-label">Datum narození:</label>
            <input type="date" class="form-control" id="clientBirthdate" required>
          </div>
          <button type="submit" class="btn btn-success">Přidat klienta</button>
        </form>
      </div>
    </div>
    
    <!-- Vyhledávání klientů -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Hledat klienta podle jména" onkeyup="filterClients()">
    </div>
    
    <!-- Globální přepínač pro skrytí hotových položek -->
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="hideCompleted" onchange="renderClients()">
      <label class="form-check-label" for="hideCompleted">Skrýt hotové položky</label>
    </div>
    
    <!-- Seznam klientů -->
    <div id="clientsList"></div>
    
    <!-- Footer s informací o verzi -->
    <footer class="text-center mt-5">
      <small>Program vytvořil Přemysl Pozděna, verze 1.0.2.</small>
    </footer>
  </div>
  
  <!-- Modál pro nastavení -->
  <div class="modal" tabindex="-1" id="settingsModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nastavení</h5>
          <button type="button" class="btn-close" onclick="hideSettings()"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" onsubmit="saveSettingsForm(event)">
            <div class="mb-3">
              <label for="settingsEvalThreshold" class="form-label">Prahová hodnota pro hodnocení (dny):</label>
              <input type="number" class="form-control" id="settingsEvalThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsPlanThreshold" class="form-label">Prahová hodnota pro plány (dny):</label>
              <input type="number" class="form-control" id="settingsPlanThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsStepThreshold" class="form-label">Prahová hodnota pro kroky (dny):</label>
              <input type="number" class="form-control" id="settingsStepThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsContractThreshold" class="form-label">Prahová hodnota pro smlouvy (dny):</label>
              <input type="number" class="form-control" id="settingsContractThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsCalendarThreshold" class="form-label">Kalendář – zobrazit v úkolech do (dny):</label>
              <input type="number" class="form-control" id="settingsCalendarThreshold" min="1" required>
            </div>
            <hr>
            <h6>Notifikace</h6>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="settingsEnableNotifications">
              <label class="form-check-label" for="settingsEnableNotifications">Povolit notifikace</label>
            </div>
            <div class="mb-3">
              <label for="settingsNotificationInterval" class="form-label">Interval notifikací (minuty):</label>
              <input type="number" class="form-control" id="settingsNotificationInterval" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary">Uložit nastavení</button>
            <button type="button" class="btn btn-danger" onclick="resetData()">Resetovat data</button>
            <button type="button" class="btn btn-warning" onclick="clearCompleted()">Vyčistit hotové položky</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modály pro editaci plánu, kroku, smlouvy (ponechány z původní verze) -->
  <!-- (editPlanModal, editStepModal, editContractModal, updateModal) -->
  <!-- ... [zbytek modálních oken z původního kódu] ... -->
  
  <!-- Modál pro grafický kalendář -->
  <div class="modal fade" id="graphicalCalendarModal" tabindex="-1" aria-labelledby="graphicalCalendarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graphicalCalendarModalLabel">Grafický kalendář</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
        </div>
        <div class="modal-body">
          <div id="calendarView"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS a FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  
  <script>
    /* Datový model:
       Klient: { id, name, birthdate, lastEvaluation, contractStart, contractExpiration, detailsVisible, plans: [] }
       Plán: { id, name, notes, expirationDate, completed, steps: [] }
       Krok: { id, description, date, completed }
       Událost: { id, title, date, details, detailsVisible }
    */
    let clients = [];
    let calendarEvents = [];
    // Rozšířená výchozí nastavení
    const defaultSettings = {
      evalThreshold: 7,
      planThreshold: 7,
      stepThreshold: 7,
      contractThreshold: 60,
      calendarThreshold: 3,
      enableNotifications: false,
      notificationInterval: 10
    };
    let settings = {};
    const appVersion = "1.0.2";
    
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadSettings();
      loadCalendarEvents();
      updateToday();
      renderClients();
      renderSummary();
      renderTasks();
      renderCalendar();
      loadDarkMode();
      registerServiceWorker();
      initNotifications();
      startNotificationInterval();
    });
    
    function updateToday() {
      const today = new Date();
      document.getElementById('todayDate').textContent = 'Dnes je: ' + today.toLocaleDateString();
    }
    
    // Export dat jako soubor
    function exportDataDownload() {
      const data = { clients, calendarEvents, settings };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ipHlidac_export.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function importData(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.clients && Array.isArray(importedData.clients)) {
              clients = importedData.clients;
              clients.forEach(client => {
                if (typeof client.detailsVisible === 'undefined') client.detailsVisible = false;
              });
            }
            if (importedData.calendarEvents && Array.isArray(importedData.calendarEvents)) {
              calendarEvents = importedData.calendarEvents;
              calendarEvents.forEach(ev => {
                if (typeof ev.detailsVisible === 'undefined') ev.detailsVisible = false;
              });
            }
            if (importedData.settings) {
              settings = importedData.settings;
            }
            saveData();
            saveCalendarEvents();
            renderClients();
            renderSummary();
            renderTasks();
            renderCalendar();
            alert('Data byla úspěšně importována.');
          } catch (error) {
            alert('Chyba při importu dat.');
          }
        };
        reader.readAsText(file);
      }
    }
    
    function loadData() {
      const data = localStorage.getItem('ipHlidacData');
      if (data) {
        clients = JSON.parse(data);
        clients.forEach(client => {
          if (typeof client.detailsVisible === 'undefined') {
            client.detailsVisible = false;
          }
        });
      }
    }
    
    function saveData() {
      localStorage.setItem('ipHlidacData', JSON.stringify(clients));
    }
    
    function loadCalendarEvents() {
      const data = localStorage.getItem('ipHlidacCalendar');
      if (data) {
        calendarEvents = JSON.parse(data);
        calendarEvents.forEach(ev => {
          if (typeof ev.detailsVisible === 'undefined') ev.detailsVisible = false;
        });
      }
    }
    
    function saveCalendarEvents() {
      localStorage.setItem('ipHlidacCalendar', JSON.stringify(calendarEvents));
    }
    
    function loadSettings() {
      const data = localStorage.getItem('ipHlidacSettings');
      if (data) {
        settings = JSON.parse(data);
      } else {
        settings = { ...defaultSettings };
      }
    }
    
    function saveSettings() {
      localStorage.setItem('ipHlidacSettings', JSON.stringify(settings));
    }
    
    function renderSummary() {
      let total = clients.length;
      let overdueEval = 0;
      let expiringPlans = 0;
      let expiringContracts = 0;
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft < 0) overdueEval++;
        } else {
          overdueEval++;
        }
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (daysLeft <= settings.planThreshold) expiringPlans++;
        });
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) expiringContracts++;
        }
      });
      document.getElementById('summaryText').textContent =
        `Celkem klientů: ${total} | Hodnocení k aktualizaci: ${overdueEval} | Plány k aktualizaci: ${expiringPlans} | Smlouvy k obnovení: ${expiringContracts}`;
    }
    
    // Upravená verze renderTasks s barevným označením dnů
    function renderTasks() {
      let tasks = [];
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasks.push(`Hodnocení u klienta ${client.name} končí za <span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span> (${evalInfo.daysLeft < 0 ? "POZDE" : "blízko"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} chybí půlroční hodnocení`);
        }
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (!plan.completed && daysLeft <= settings.planThreshold) {
            tasks.push(`Plán "${plan.name}" u klienta ${client.name} končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span> (${daysLeft < 0 ? "POZDE" : "brzy"})`);
          }
          plan.steps.forEach(step => {
            if (!step.completed) {
              const daysLeftStep = calculateDaysLeft(step.date);
              if (daysLeftStep <= settings.stepThreshold) {
                tasks.push(`Krok "${step.description}" u plánu "${plan.name}" (klient ${client.name}) končí za <span class="${getDaysClass(daysLeftStep)}">${daysLeftStep} dní</span> (${daysLeftStep < 0 ? "POZDE" : "blízko"})`);
              }
            }
          });
        });
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasks.push(`Smlouva u klienta ${client.name} končí za <span class="${getDaysClass(contractDaysLeft)}">${contractDaysLeft} dní</span> (${contractDaysLeft < 0 ? "VYPRŠELA" : "brzy"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} není nastavena smlouva`);
        }
      });
      calendarEvents.forEach(event => {
        const daysLeft = calculateDaysLeft(event.date);
        if (daysLeft <= settings.calendarThreshold) {
          tasks.push(`Událost "${event.title}" končí za <span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span> (${daysLeft < 0 ? "POZDE" : "blízko"})`);
        }
      });
      let tasksHTML = "";
      if (tasks.length === 0) {
        tasksHTML = "<p>Žádné úkoly k vyřízení.</p>";
      } else {
        tasksHTML = "<ul class='list-group'>";
        tasks.forEach(task => {
          tasksHTML += `<li class="list-group-item">${task}</li>`;
        });
        tasksHTML += "</ul>";
      }
      document.getElementById('tasksList').innerHTML = tasksHTML;
    }
    
    function renderCalendar() {
      let html = "";
      if (calendarEvents.length === 0) {
        html = "<p>Žádné události zatím nebyly přidány.</p>";
      } else {
        html = "<ul class='list-group'>";
        calendarEvents.forEach(event => {
          html += `<li class="list-group-item d-flex flex-column">
                     <div class="d-flex justify-content-between align-items-center">
                       <span>${event.title} - ${new Date(event.date).toLocaleDateString()}</span>
                       <div>
                         ${event.details ? `<button class="btn btn-sm btn-info me-1" onclick="toggleCalendarDetails('${event.id}')">
                           ${event.detailsVisible ? 'Skrýt detaily' : 'Zobrazit detaily'}
                         </button>` : ""}
                         <button class="btn btn-sm btn-danger" onclick="deleteCalendarEvent('${event.id}')">X</button>
                       </div>
                     </div>
                     ${event.detailsVisible && event.details ? `<div class="mt-2">${event.details}</div>` : ""}
                   </li>`;
        });
        html += "</ul>";
      }
      document.getElementById('calendarList').innerHTML = html;
    }
    
    function addCalendarEvent(e) {
      e.preventDefault();
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const details = document.getElementById('eventDetails').value.trim();
      if (title && date) {
        const newEvent = {
          id: generateId(),
          title: title,
          date: date,
          details: details,
          detailsVisible: false
        };
        calendarEvents.push(newEvent);
        saveCalendarEvents();
        renderCalendar();
        renderTasks();
        document.getElementById('calendarForm').reset();
      }
    }
    
    function deleteCalendarEvent(eventId) {
      calendarEvents = calendarEvents.filter(ev => ev.id !== eventId);
      saveCalendarEvents();
      renderCalendar();
      renderTasks();
    }
    
    function toggleCalendarDetails(eventId) {
      const event = calendarEvents.find(ev => ev.id === eventId);
      if (event) {
        event.detailsVisible = !event.detailsVisible;
        saveCalendarEvents();
        renderCalendar();
      }
    }
    
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Přidání nového klienta
    function addClient(event) {
      event.preventDefault();
      const name = document.getElementById('clientName').value.trim();
      const birthdate = document.getElementById('clientBirthdate').value;
      if (name && birthdate) {
        const newClient = {
          id: generateId(),
          name: name,
          birthdate: birthdate,
          lastEvaluation: null,
          contractStart: null,
          contractExpiration: null,
          detailsVisible: false,
          plans: []
        };
        clients.push(newClient);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        document.getElementById('clientForm').reset();
      }
    }
    
    function deleteClient(clientId) {
      if (confirm('Opravdu chceš odstranit tohoto klienta?')) {
        clients = clients.filter(client => client.id !== clientId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    function updateEvaluation(event, clientId) {
      event.preventDefault();
      const input = document.getElementById('eval_' + clientId);
      const client = clients.find(c => c.id === clientId);
      if (client && input.value) {
        client.lastEvaluation = input.value;
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        input.value = "";
      }
    }
    
    function addPlan(event, clientId) {
      event.preventDefault();
      const form = event.target;
      const planName = form.elements['planName'].value.trim();
      const planNotes = form.elements['planNotes'].value.trim();
      const planExpiration = form.elements['planExpiration'].value;
      if (planName && planExpiration) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const newPlan = {
            id: generateId(),
            name: planName,
            notes: planNotes,
            expirationDate: planExpiration,
            completed: false,
            steps: []
          };
          client.plans.push(newPlan);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
          form.reset();
        }
      }
    }
    
    function deletePlan(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.plans = client.plans.filter(plan => plan.id !== planId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    function addStep(event, clientId, planId) {
      event.preventDefault();
      const form = event.target;
      const stepDesc = form.elements['stepDesc'].value.trim();
      const stepDate = form.elements['stepDate'].value;
      if (stepDesc && stepDate) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const plan = client.plans.find(p => p.id === planId);
          if (plan) {
            const newStep = {
              id: generateId(),
              description: stepDesc,
              date: stepDate,
              completed: false
            };
            plan.steps.push(newStep);
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
            form.reset();
          }
        }
      }
    }
    
    function deleteStep(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.steps = plan.steps.filter(step => step.id !== stepId);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    function togglePlanCompletion(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.completed = !plan.completed;
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    function toggleStepCompletion(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            step.completed = !step.completed;
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
          }
        }
      }
    }
    
    function toggleClientDetails(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.detailsVisible = !client.detailsVisible;
        saveData();
        renderClients();
      }
    }
    
    function filterClients() {
      renderClients();
    }
    
    function renderClients() {
      const container = document.getElementById('clientsList');
      container.innerHTML = "";
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const hideCompleted = document.getElementById('hideCompleted').checked;
      if (clients.length === 0) {
        container.innerHTML = "<p>Žádní klienti zatím nejsou přidáni.</p>";
        return;
      }
      clients.forEach(client => {
        if (searchQuery && !client.name.toLowerCase().includes(searchQuery)) return;
        const clientCard = document.createElement('div');
        clientCard.className = "card mb-4";
        let clientHTML = `
          <div class="card-header">
            <strong>${client.name}</strong> (Narozen: ${new Date(client.birthdate).toLocaleDateString()})
            <div class="float-end">
              <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">Odstranit klienta</button>
              <button class="btn btn-sm btn-info" onclick="toggleClientDetails('${client.id}')">
                ${client.detailsVisible ? 'Skrýt detaily' : 'Zobrazit detaily'}
              </button>
            </div>
          </div>
          <div class="collapse ${client.detailsVisible ? 'show' : ''}" id="collapseClient_${client.id}">
            <div class="card-body">
              <div class="mb-3">
                <h6>Půlroční hodnocení:</h6>`;
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          clientHTML += `<p>Poslední: ${new Date(client.lastEvaluation).toLocaleDateString()} | Další: ${evalInfo.nextEvaluation.toLocaleDateString()} (<span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>)</p>`;
        } else {
          clientHTML += `<p>Zatím nebylo provedeno žádné hodnocení.</p>`;
        }
        clientHTML += `
                <form class="mb-3" onsubmit="updateEvaluation(event, '${client.id}')">
                  <div class="mb-2">
                    <input type="date" id="eval_${client.id}" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-sm btn-primary">Nastavit/Aktualizovat hodnocení</button>
                </form>
              </div>
              <div class="mb-3">
                <h6>Smlouva:</h6>`;
        if (client.contractStart && client.contractExpiration) {
          clientHTML += `<p>Od: ${new Date(client.contractStart).toLocaleDateString()} do: ${new Date(client.contractExpiration).toLocaleDateString()}</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Upravit smlouvu</button>`;
        } else {
          clientHTML += `<p>Smlouva není nastavena.</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Přidat smlouvu</button>`;
        }
        clientHTML += `</div>
              <div class="mb-3">
                <h5>Individuální plány:</h5>`;
        if (client.plans.length === 0) {
          clientHTML += `<p>Žádné plány zatím nebyly přidány.</p>`;
        } else {
          client.plans.forEach(plan => {
            if (hideCompleted && plan.completed) return;
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            clientHTML += `
              <div class="card mb-3">
                <div class="card-header">
                  <strong>${plan.name}</strong> - Platnost do: ${new Date(plan.expirationDate).toLocaleDateString()} (<span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>)
                  ${plan.completed ? '<span class="badge bg-success">Hotový</span>' : ''}
                  <div class="float-end">
                    <button class="btn btn-sm btn-warning" onclick="togglePlanCompletion('${client.id}', '${plan.id}')">
                      ${plan.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editPlan('${client.id}', '${plan.id}')">Upravit</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePlan('${client.id}', '${plan.id}')">Odstranit</button>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlan_${client.id}_${plan.id}" aria-expanded="false" aria-controls="collapsePlan_${client.id}_${plan.id}">Zobrazit kroky</button>
                  </div>
                </div>
                <div class="collapse" id="collapsePlan_${client.id}_${plan.id}">
                  <div class="card-body">
                    <p><strong>Poznámky:</strong> ${plan.notes || 'žádné'}</p>`;
            if (plan.steps.length === 0) {
              clientHTML += `<p>Žádné kroky ještě nebyly přidány.</p>`;
            } else {
              clientHTML += `<ul class="list-group mb-2">`;
              plan.steps.forEach(step => {
                if (hideCompleted && step.completed) return;
                clientHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${step.description} - ${new Date(step.date).toLocaleDateString()}
                                ${step.completed ? '<span class="badge bg-success">Hotový</span>' : ''}
                                <div>
                                  <button class="btn btn-sm btn-warning" onclick="toggleStepCompletion('${client.id}', '${plan.id}', '${step.id}')">
                                    ${step.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                                  </button>
                                  <button class="btn btn-sm btn-secondary" onclick="editStep('${client.id}', '${plan.id}', '${step.id}')">Upravit</button>
                                  <button class="btn btn-sm btn-danger" onclick="deleteStep('${client.id}', '${plan.id}', '${step.id}')">X</button>
                                </div>
                              </li>`;
              });
              clientHTML += `</ul>`;
            }
            clientHTML += `
                    <form onsubmit="addStep(event, '${client.id}', '${plan.id}')">
                      <div class="mb-2">
                        <input type="text" name="stepDesc" class="form-control" placeholder="Popis kroku" required>
                      </div>
                      <div class="mb-2">
                        <input type="date" name="stepDate" class="form-control" required>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Přidat krok</button>
                    </form>
                  </div>
                </div>
              </div>`;
          });
        }
        clientHTML += `
                <div class="mb-3">
                  <h5>Přidat individuální plán:</h5>
                  <form onsubmit="addPlan(event, '${client.id}')">
                    <div class="mb-2">
                      <input type="text" name="planName" class="form-control" placeholder="Název plánu" required>
                    </div>
                    <div class="mb-2">
                      <textarea name="planNotes" class="form-control" placeholder="Poznámky (volitelné)"></textarea>
                    </div>
                    <div class="mb-2">
                      <label>Platnost do:</label>
                      <input type="date" name="planExpiration" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-success">Přidat plán</button>
                  </form>
                </div>
              </div>
            </div>`;
        clientCard.innerHTML = clientHTML;
        container.appendChild(clientCard);
      });
    }
    
    // (Funkce pro editaci plánu, kroku, smlouvy atd. zůstávají beze změny – viz předchozí kód)
    
    // Tmavý režim
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'true' : 'false');
    }
    
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
      }
    }
    
    // Pomocné funkce pro výpočet dnů
    function calculateDaysLeft(expirationDate) {
      const today = new Date();
      const expDate = new Date(expirationDate);
      const diffTime = expDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
    
    function calculateEvalDays(lastEval) {
      const evalDate = new Date(lastEval);
      evalDate.setMonth(evalDate.getMonth() + 6);
      const today = new Date();
      const diffTime = evalDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return { nextEvaluation: evalDate, daysLeft: diffDays };
    }
    
    function getDaysClass(days) {
      if (days > 5) return 'days-green';
      if (days >= 0 && days <= 5) return 'days-orange';
      return 'days-red';
    }
    
    // Service Worker registrace s notifikací nové verze
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => {
            reg.onupdatefound = () => {
              const newWorker = reg.installing;
              newWorker.onstatechange = () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdateModal();
                }
              }
            };
          })
          .catch(err => console.error('Chyba při registraci Service Workeru:', err));
      }
    }
    
    function showUpdateModal() {
      // Zobrazit modál s informací o nové verzi (pokud je potřeba)
      // Např. pomocí Bootstrap Modal:
      const modal = new bootstrap.Modal(document.getElementById('updateModal'));
      modal.show();
    }
    
    function updateApp() {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (reg && reg.waiting) {
          reg.waiting.postMessage({ action: 'skipWaiting' });
        }
        window.location.reload();
      });
    }
    
    // Notification API
    function initNotifications() {
      if ("Notification" in window) {
        if (Notification.permission === "default") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              console.log("Notifikace povoleny.");
            }
          });
        }
      }
    }
    
    function showNotification(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, { body: body, icon: "icons/icon-192.png" });
      }
    }
    
    function getPendingTasks() {
      let tasks = [];
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasks.push(`Hodnocení u ${client.name} - zbývá ${evalInfo.daysLeft} dní`);
          }
        } else {
          tasks.push(`U ${client.name} chybí hodnocení`);
        }
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (!plan.completed && daysLeft <= settings.planThreshold) {
            tasks.push(`Plán "${plan.name}" u ${client.name} - zbývá ${daysLeft} dní`);
          }
          plan.steps.forEach(step => {
            if (!step.completed) {
              const daysLeftStep = calculateDaysLeft(step.date);
              if (daysLeftStep <= settings.stepThreshold) {
                tasks.push(`Krok "${step.description}" u plánu "${plan.name}" - zbývá ${daysLeftStep} dní`);
              }
            }
          });
        });
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasks.push(`Smlouva u ${client.name} - zbývá ${contractDaysLeft} dní`);
          }
        } else {
          tasks.push(`U ${client.name} není smlouva nastavena`);
        }
      });
      calendarEvents.forEach(event => {
        const daysLeft = calculateDaysLeft(event.date);
        if (daysLeft <= settings.calendarThreshold) {
          tasks.push(`Událost "${event.title}" - zbývá ${daysLeft} dní`);
        }
      });
      return tasks;
    }
    
    function checkAndNotify() {
      if (!settings.enableNotifications) return;
      const tasks = getPendingTasks();
      if (tasks.length > 0) {
        let notificationBody = tasks.slice(0, 5).join("\n");
        if (tasks.length > 5) {
          notificationBody += "\n... a další úkoly";
        }
        showNotification("Máte úkoly k vyřízení", notificationBody);
      }
    }
    
    function startNotificationInterval() {
      if (window.notificationIntervalId) clearInterval(window.notificationIntervalId);
      if (settings.enableNotifications) {
        window.notificationIntervalId = setInterval(checkAndNotify, settings.notificationInterval * 60000);
      }
    }
    
    // ---------------------------
    // Grafický kalendář (FullCalendar)
    // ---------------------------
    // Funkce pro sestavení seznamu událostí z různých zdrojů
    function getGraphicalCalendarEvents() {
      let events = [];
      // Události z klientů – hodnocení, plány, kroky, smlouvy
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          events.push({
            id: generateId(),
            title: `Hodnocení: ${client.name}`,
            start: evalInfo.nextEvaluation.toISOString().split("T")[0],
            allDay: true,
            extendedProps: { type: 'evaluation', client: client.name }
          });
        }
        client.plans.forEach(plan => {
          events.push({
            id: generateId(),
            title: `Plán: ${plan.name} (${client.name})`,
            start: plan.expirationDate,
            allDay: true,
            extendedProps: { type: 'plan', client: client.name }
          });
          plan.steps.forEach(step => {
            if (!step.completed) {
              events.push({
                id: generateId(),
                title: `Krok: ${step.description} (${client.name})`,
                start: step.date,
                allDay: true,
                extendedProps: { type: 'step', client: client.name }
              });
            }
          });
        });
        if (client.contractExpiration) {
          events.push({
            id: generateId(),
            title: `Smlouva: ${client.name}`,
            start: client.contractExpiration,
            allDay: true,
            extendedProps: { type: 'contract', client: client.name }
          });
        }
      });
      // Vlastní kalendářové události
      calendarEvents.forEach(ev => {
        events.push({
          id: ev.id,
          title: `Událost: ${ev.title}`,
          start: ev.date,
          allDay: true,
          extendedProps: { type: 'calendar', details: ev.details }
        });
      });
      return events;
    }
    
    // Inicializace FullCalendar v modálu
    function initGraphicalCalendar() {
      const calendarEl = document.getElementById('calendarView');
      calendarEl.innerHTML = ""; // Vyčistit starý obsah
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridWeek',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridWeek,dayGridMonth'
        },
        events: getGraphicalCalendarEvents(),
        eventClick: function(info) {
          // Po kliknutí zobrazit detail a tlačítko pro Google Kalendář
          let details = `Název: ${info.event.title}\nDatum: ${info.event.start.toLocaleDateString()}`;
          if(info.event.extendedProps.details) {
            details += `\nDetaily: ${info.event.extendedProps.details}`;
          }
          // Sestavení URL pro Google Kalendář (jednoduchá verze, událost je celodenní)
          const startDate = info.event.start.toISOString().split("T")[0].replace(/-/g, "");
          const endDate = startDate;
          const gcUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(info.event.title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
          if(confirm(details + "\n\nPřejete si přidat tuto událost do Google Kalendáře?")) {
            window.open(gcUrl, '_blank');
          }
        }
      });
      calendar.render();
    }
    
    // Při otevření modálu s grafickým kalendářem inicializovat FullCalendar
    const graphicalCalendarModal = document.getElementById('graphicalCalendarModal');
    graphicalCalendarModal.addEventListener('shown.bs.modal', initGraphicalCalendar);
    
  </script>
</body>
</html>
