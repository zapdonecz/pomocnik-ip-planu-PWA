<!DOCTYPE html>
<html lang="cs">
<head>
  <link rel="manifest" href="manifest.json">

  <meta charset="UTF-8">
  <title>IP hlídač</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .days-green {
      color: green;
      font-weight: bold;
    }
    .days-orange {
      color: orange;
      font-weight: bold;
    }
    .days-red {
      color: red;
      font-weight: bold;
    }
    /* Tmavý režim */
    body.dark-mode {
      background: #333;
      color: #eee;
    }
    body.dark-mode .card {
      background: #444;
      border-color: #555;
    }
    body.dark-mode .list-group-item {
      background: #444;
      border-color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">IP hlídač</h1>
      <button class="btn btn-outline-secondary" onclick="toggleDarkMode()">Tmavý režim</button>
    </div>
    <p id="todayDate" class="mb-4"></p>
    
    <!-- Souhrn -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Přehled</h5>
        <p id="summaryText"></p>
      </div>
    </div>
    
    <!-- Úkoly k vyřízení -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Úkoly k vyřízení</h5>
        <div id="tasksList"></div>
      </div>
    </div>
    
    <!-- Export/Import a Nastavení -->
    <div class="mb-4">
      <button class="btn btn-primary" onclick="showExport()">Export dat</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import dat</button>
      <button class="btn btn-secondary" onclick="showSettings()">Nastavení</button>
      <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
    
    <!-- Formulář pro přidání nového klienta -->
    <div class="card mb-4">
      <div class="card-header">
        Přidat nového klienta
      </div>
      <div class="card-body">
        <form id="clientForm" onsubmit="addClient(event)">
          <div class="mb-3">
            <label for="clientName" class="form-label">Jméno klienta:</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="mb-3">
            <label for="clientBirthdate" class="form-label">Datum narození:</label>
            <input type="date" class="form-control" id="clientBirthdate" required>
          </div>
          <button type="submit" class="btn btn-success">Přidat klienta</button>
        </form>
      </div>
    </div>
    
    <!-- Vyhledávání klientů -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Hledat klienta podle jména" onkeyup="filterClients()">
    </div>
    
    <!-- Globální přepínač pro skrytí hotových položek -->
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="hideCompleted" onchange="renderClients()">
      <label class="form-check-label" for="hideCompleted">Skrýt hotové položky</label>
    </div>
    
    <!-- Seznam klientů -->
    <div id="clientsList"></div>
  </div>
  
  <!-- Export modal -->
  <div class="modal" tabindex="-1" id="exportModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export dat</h5>
          <button type="button" class="btn-close" onclick="hideExport()"></button>
        </div>
        <div class="modal-body">
          <textarea id="exportData" class="form-control" rows="10" readonly></textarea>
          <p class="mt-2">Zkopíruj data nebo si je ulož do souboru.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideExport()">Zavřít</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace plánu modal -->
  <div class="modal" tabindex="-1" id="editPlanModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit plán</h5>
          <button type="button" class="btn-close" onclick="hideEditPlanModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editPlanForm" onsubmit="savePlanEdits(event)">
            <div class="mb-3">
              <label for="editPlanName" class="form-label">Název plánu:</label>
              <input type="text" class="form-control" id="editPlanName" required>
            </div>
            <div class="mb-3">
              <label for="editPlanNotes" class="form-label">Poznámky:</label>
              <textarea class="form-control" id="editPlanNotes"></textarea>
            </div>
            <div class="mb-3">
              <label for="editPlanExpiration" class="form-label">Platnost do:</label>
              <input type="date" class="form-control" id="editPlanExpiration" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="editPlanCompleted">
              <label class="form-check-label" for="editPlanCompleted">Hotový</label>
            </div>
            <input type="hidden" id="editPlanClientId">
            <input type="hidden" id="editPlanId">
            <button type="submit" class="btn btn-primary">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace kroku modal -->
  <div class="modal" tabindex="-1" id="editStepModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit krok</h5>
          <button type="button" class="btn-close" onclick="hideEditStepModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editStepForm" onsubmit="saveStepEdits(event)">
            <div class="mb-3">
              <label for="editStepDescription" class="form-label">Popis kroku:</label>
              <input type="text" class="form-control" id="editStepDescription" required>
            </div>
            <div class="mb-3">
              <label for="editStepDate" class="form-label">Datum:</label>
              <input type="date" class="form-control" id="editStepDate" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="editStepCompleted">
              <label class="form-check-label" for="editStepCompleted">Hotový</label>
            </div>
            <input type="hidden" id="editStepClientId">
            <input type="hidden" id="editStepPlanId">
            <input type="hidden" id="editStepId">
            <button type="submit" class="btn btn-primary">Uložit změny</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editace smlouvy modal -->
  <div class="modal" tabindex="-1" id="editContractModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upravit smlouvu</h5>
          <button type="button" class="btn-close" onclick="hideEditContractModal()"></button>
        </div>
        <div class="modal-body">
          <form id="editContractForm" onsubmit="saveContractEdits(event)">
            <div class="mb-3">
              <label for="editContractStart" class="form-label">Datum smlouvy (začátek):</label>
              <input type="date" class="form-control" id="editContractStart" required>
            </div>
            <div class="mb-3">
              <label for="editContractExpiration" class="form-label">Platnost do:</label>
              <input type="date" class="form-control" id="editContractExpiration" required>
            </div>
            <input type="hidden" id="editContractClientId">
            <button type="submit" class="btn btn-primary">Uložit smlouvu</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Nastavení modal -->
  <div class="modal" tabindex="-1" id="settingsModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nastavení</h5>
          <button type="button" class="btn-close" onclick="hideSettings()"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" onsubmit="saveSettingsForm(event)">
            <div class="mb-3">
              <label for="settingsEvalThreshold" class="form-label">Prahová hodnota pro hodnocení (dny):</label>
              <input type="number" class="form-control" id="settingsEvalThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsPlanThreshold" class="form-label">Prahová hodnota pro plány (dny):</label>
              <input type="number" class="form-control" id="settingsPlanThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsStepThreshold" class="form-label">Prahová hodnota pro kroky (dny):</label>
              <input type="number" class="form-control" id="settingsStepThreshold" min="1" required>
            </div>
            <div class="mb-3">
              <label for="settingsContractThreshold" class="form-label">Prahová hodnota pro smlouvy (dny):</label>
              <input type="number" class="form-control" id="settingsContractThreshold" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary">Uložit nastavení</button>
            <button type="button" class="btn btn-danger" onclick="resetData()">Resetovat data</button>
            <button type="button" class="btn btn-warning" onclick="clearCompleted()">Vyčistit hotové položky</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* Datový model:
       Klient: { id, name, birthdate, lastEvaluation, contractStart, contractExpiration, detailsVisible, plans: [] }
       Plán: { id, name, notes, expirationDate, completed, steps: [] }
       Krok: { id, description, date, completed }
    */
    let clients = [];
    // Nastavení prahových hodnot – lze měnit v modalu
    const defaultSettings = {
      evalThreshold: 7,
      planThreshold: 7,
      stepThreshold: 7,
      contractThreshold: 60
    };
    let settings = {};
    
    // Načteme data a nastavení při startu
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadSettings();
      updateToday();
      renderClients();
      renderSummary();
      renderTasks();
      loadDarkMode();
    });
    
    function updateToday() {
      const today = new Date();
      document.getElementById('todayDate').textContent = 'Dnes je: ' + today.toLocaleDateString();
    }
    
    function saveData() {
      localStorage.setItem('ipHlidacData', JSON.stringify(clients));
    }
    
    function loadData() {
      const data = localStorage.getItem('ipHlidacData');
      if (data) {
        clients = JSON.parse(data);
        // Pokud klientům chybí vlastnost detailsVisible, nastavíme defaultně false
        clients.forEach(client => {
          if (typeof client.detailsVisible === 'undefined') {
            client.detailsVisible = false;
          }
        });
      }
    }
    
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Přidání nového klienta
    function addClient(event) {
      event.preventDefault();
      const name = document.getElementById('clientName').value.trim();
      const birthdate = document.getElementById('clientBirthdate').value;
      if (name && birthdate) {
        const newClient = {
          id: generateId(),
          name: name,
          birthdate: birthdate,
          lastEvaluation: null,
          contractStart: null,
          contractExpiration: null,
          detailsVisible: false,
          plans: []
        };
        clients.push(newClient);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        document.getElementById('clientForm').reset();
      }
    }
    
    // Smazání klienta
    function deleteClient(clientId) {
      if (confirm('Opravdu chceš odstranit tohoto klienta?')) {
        clients = clients.filter(client => client.id !== clientId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    // Aktualizace půlročního hodnocení
    function updateEvaluation(event, clientId) {
      event.preventDefault();
      const input = document.getElementById('eval_' + clientId);
      const client = clients.find(c => c.id === clientId);
      if (client && input.value) {
        client.lastEvaluation = input.value;
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
        input.value = "";
      }
    }
    
    // Přidání plánu
    function addPlan(event, clientId) {
      event.preventDefault();
      const form = event.target;
      const planName = form.elements['planName'].value.trim();
      const planNotes = form.elements['planNotes'].value.trim();
      const planExpiration = form.elements['planExpiration'].value;
      if (planName && planExpiration) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const newPlan = {
            id: generateId(),
            name: planName,
            notes: planNotes,
            expirationDate: planExpiration,
            completed: false,
            steps: []
          };
          client.plans.push(newPlan);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
          form.reset();
        }
      }
    }
    
    // Smazání plánu
    function deletePlan(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.plans = client.plans.filter(plan => plan.id !== planId);
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    // Přidání kroku
    function addStep(event, clientId, planId) {
      event.preventDefault();
      const form = event.target;
      const stepDesc = form.elements['stepDesc'].value.trim();
      const stepDate = form.elements['stepDate'].value;
      if (stepDesc && stepDate) {
        const client = clients.find(c => c.id === clientId);
        if (client) {
          const plan = client.plans.find(p => p.id === planId);
          if (plan) {
            const newStep = {
              id: generateId(),
              description: stepDesc,
              date: stepDate,
              completed: false
            };
            plan.steps.push(newStep);
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
            form.reset();
          }
        }
      }
    }
    
    // Smazání kroku
    function deleteStep(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.steps = plan.steps.filter(step => step.id !== stepId);
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    // Označit/odznačit plán jako hotový
    function togglePlanCompletion(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.completed = !plan.completed;
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
    }
    
    // Označit/odznačit krok jako hotový
    function toggleStepCompletion(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            step.completed = !step.completed;
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
          }
        }
      }
    }
    
    // Výpočet zbývajících dnů do expirace (plánu, smlouvy nebo kroku)
    function calculateDaysLeft(expirationDate) {
      const today = new Date();
      const expDate = new Date(expirationDate);
      const diffTime = expDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
    
    // Výpočet dnů do dalšího půlročního hodnocení
    function calculateEvalDays(lastEval) {
      const evalDate = new Date(lastEval);
      evalDate.setMonth(evalDate.getMonth() + 6);
      const today = new Date();
      const diffTime = evalDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return { nextEvaluation: evalDate, daysLeft: diffDays };
    }
    
    function getDaysClass(days) {
      if (days > 5) {
        return 'days-green';
      } else if (days >= 0 && days <= 5) {
        return 'days-orange';
      } else {
        return 'days-red';
      }
    }
    
    // Vykreslení souhrnu
    function renderSummary() {
      let total = clients.length;
      let overdueEval = 0;
      let expiringPlans = 0;
      let expiringContracts = 0;
      clients.forEach(client => {
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft < 0) overdueEval++;
        } else {
          overdueEval++;
        }
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (daysLeft <= settings.planThreshold) expiringPlans++;
        });
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) expiringContracts++;
        }
      });
      const summaryText = `Celkem klientů: ${total} | Hodnocení k aktualizaci: ${overdueEval} | Plány k aktualizaci: ${expiringPlans} | Smlouvy k obnovení: ${expiringContracts}`;
      document.getElementById('summaryText').textContent = summaryText;
    }
    
    // Vykreslení úkolů k vyřízení (včetně kroků)
    function renderTasks() {
      let tasks = [];
      clients.forEach(client => {
        // Půlroční hodnocení
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          if (evalInfo.daysLeft <= settings.evalThreshold) {
            tasks.push(`Hodnocení u klienta ${client.name} končí za ${evalInfo.daysLeft} dní (${evalInfo.daysLeft < 0 ? "POZDE" : "blízko"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} chybí půlroční hodnocení`);
        }
        // Expirace plánů
        client.plans.forEach(plan => {
          const daysLeft = calculateDaysLeft(plan.expirationDate);
          if (!plan.completed && daysLeft <= settings.planThreshold) {
            tasks.push(`Plán "${plan.name}" u klienta ${client.name} končí za ${daysLeft} dní (${daysLeft < 0 ? "POZDE" : "brzy"})`);
          }
          // Expirace kroků
          plan.steps.forEach(step => {
            if (!step.completed) {
              const daysLeftStep = calculateDaysLeft(step.date);
              if (daysLeftStep <= settings.stepThreshold) {
                tasks.push(`Krok "${step.description}" u plánu "${plan.name}" (klient ${client.name}) končí za ${daysLeftStep} dní (${daysLeftStep < 0 ? "POZDE" : "blízko"})`);
              }
            }
          });
        });
        // Expirace smlouvy
        if (client.contractExpiration) {
          const contractDaysLeft = calculateDaysLeft(client.contractExpiration);
          if (contractDaysLeft <= settings.contractThreshold) {
            tasks.push(`Smlouva u klienta ${client.name} končí za ${contractDaysLeft} dní (${contractDaysLeft < 0 ? "VYPRŠELA" : "brzy"})`);
          }
        } else {
          tasks.push(`U klienta ${client.name} není nastavena smlouva`);
        }
      });
      let tasksHTML = "";
      if (tasks.length === 0) {
        tasksHTML = "<p>Žádné úkoly k vyřízení.</p>";
      } else {
        tasksHTML = "<ul class='list-group'>";
        tasks.forEach(task => {
          tasksHTML += `<li class="list-group-item">${task}</li>`;
        });
        tasksHTML += "</ul>";
      }
      document.getElementById('tasksList').innerHTML = tasksHTML;
    }
    
    // Vykreslení klientů, plánů a kroků
    function renderClients() {
      const container = document.getElementById('clientsList');
      container.innerHTML = "";
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const hideCompleted = document.getElementById('hideCompleted').checked;
      if (clients.length === 0) {
        container.innerHTML = "<p>Žádní klienti zatím nejsou přidáni.</p>";
        return;
      }
      clients.forEach(client => {
        if (searchQuery && !client.name.toLowerCase().includes(searchQuery)) return;
        // Karta klienta
        const clientCard = document.createElement('div');
        clientCard.className = "card mb-4";
        let clientHTML = `
          <div class="card-header">
            <strong>${client.name}</strong> (Narozen: ${new Date(client.birthdate).toLocaleDateString()})
            <div class="float-end">
              <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">Odstranit klienta</button>
              <button class="btn btn-sm btn-info" onclick="toggleClientDetails('${client.id}')">
                ${client.detailsVisible ? 'Skrýt detaily' : 'Zobrazit detaily'}
              </button>
            </div>
          </div>
          <div class="collapse ${client.detailsVisible ? 'show' : ''}" id="collapseClient_${client.id}">
            <div class="card-body">
              <!-- Půlroční hodnocení -->
              <div class="mb-3">
                <h6>Půlroční hodnocení:</h6>`;
        if (client.lastEvaluation) {
          const evalInfo = calculateEvalDays(client.lastEvaluation);
          clientHTML += `<p>Poslední: ${new Date(client.lastEvaluation).toLocaleDateString()} | Další: ${evalInfo.nextEvaluation.toLocaleDateString()} 
                           (<span class="${getDaysClass(evalInfo.daysLeft)}">${evalInfo.daysLeft} dní</span>)</p>`;
        } else {
          clientHTML += `<p>Zatím nebylo provedeno žádné hodnocení.</p>`;
        }
        clientHTML += `
                <form class="mb-3" onsubmit="updateEvaluation(event, '${client.id}')">
                  <div class="mb-2">
                    <input type="date" id="eval_${client.id}" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-sm btn-primary">Nastavit/Aktualizovat hodnocení</button>
                </form>
              </div>
              <!-- Smlouva -->
              <div class="mb-3">
                <h6>Smlouva:</h6>`;
        if (client.contractStart && client.contractExpiration) {
          clientHTML += `<p>Od: ${new Date(client.contractStart).toLocaleDateString()} do: ${new Date(client.contractExpiration).toLocaleDateString()}</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Upravit smlouvu</button>`;
        } else {
          clientHTML += `<p>Smlouva není nastavena.</p>
                         <button class="btn btn-sm btn-primary" onclick="editContract('${client.id}')">Přidat smlouvu</button>`;
        }
        clientHTML += `</div>
              <!-- Plány -->
              <div class="mb-3">
                <h5>Individuální plány:</h5>`;
        if (client.plans.length === 0) {
          clientHTML += `<p>Žádné plány zatím nebyly přidány.</p>`;
        } else {
          client.plans.forEach(plan => {
            if (hideCompleted && plan.completed) return;
            const daysLeft = calculateDaysLeft(plan.expirationDate);
            clientHTML += `
              <div class="card mb-3">
                <div class="card-header">
                  <strong>${plan.name}</strong> - Platnost do: ${new Date(plan.expirationDate).toLocaleDateString()} 
                  (<span class="${getDaysClass(daysLeft)}">${daysLeft} dní</span>)
                  ${plan.completed ? '<span class="badge bg-success">Hotový</span>' : ''}
                  <div class="float-end">
                    <button class="btn btn-sm btn-warning" onclick="togglePlanCompletion('${client.id}', '${plan.id}')">
                      ${plan.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editPlan('${client.id}', '${plan.id}')">Upravit</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePlan('${client.id}', '${plan.id}')">Odstranit</button>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlan_${client.id}_${plan.id}" aria-expanded="false" aria-controls="collapsePlan_${client.id}_${plan.id}">Zobrazit kroky</button>
                  </div>
                </div>
                <div class="collapse" id="collapsePlan_${client.id}_${plan.id}">
                  <div class="card-body">
                    <p><strong>Poznámky:</strong> ${plan.notes || 'žádné'}</p>`;
            // Kroky
            if (plan.steps.length === 0) {
              clientHTML += `<p>Žádné kroky ještě nebyly přidány.</p>`;
            } else {
              clientHTML += `<ul class="list-group mb-2">`;
              plan.steps.forEach(step => {
                if (hideCompleted && step.completed) return;
                clientHTML += `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${step.description} - ${new Date(step.date).toLocaleDateString()}
                    ${step.completed ? '<span class="badge bg-success">Hotový</span>' : ''}
                    <div>
                      <button class="btn btn-sm btn-warning" onclick="toggleStepCompletion('${client.id}', '${plan.id}', '${step.id}')">
                        ${step.completed ? 'Zrušit hotovo' : 'Označit jako hotový'}
                      </button>
                      <button class="btn btn-sm btn-secondary" onclick="editStep('${client.id}', '${plan.id}', '${step.id}')">Upravit</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteStep('${client.id}', '${plan.id}', '${step.id}')">X</button>
                    </div>
                  </li>`;
              });
              clientHTML += `</ul>`;
            }
            // Formulář pro přidání kroku
            clientHTML += `
                    <form onsubmit="addStep(event, '${client.id}', '${plan.id}')">
                      <div class="mb-2">
                        <input type="text" name="stepDesc" class="form-control" placeholder="Popis kroku" required>
                      </div>
                      <div class="mb-2">
                        <input type="date" name="stepDate" class="form-control" required>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Přidat krok</button>
                    </form>
                  </div>
                </div>
              </div>`;
          });
        }
        // Formulář pro přidání nového plánu
        clientHTML += `
                <div class="mb-3">
                  <h5>Přidat individuální plán:</h5>
                  <form onsubmit="addPlan(event, '${client.id}')">
                    <div class="mb-2">
                      <input type="text" name="planName" class="form-control" placeholder="Název plánu" required>
                    </div>
                    <div class="mb-2">
                      <textarea name="planNotes" class="form-control" placeholder="Poznámky (volitelné)"></textarea>
                    </div>
                    <div class="mb-2">
                      <label>Platnost do:</label>
                      <input type="date" name="planExpiration" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-success">Přidat plán</button>
                  </form>
                </div>`;
        clientHTML += `</div></div>`;
        clientCard.innerHTML = clientHTML;
        container.appendChild(clientCard);
      });
    }
    
    // Přepínání zobrazení detailů klienta a ukládání stavu
    function toggleClientDetails(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.detailsVisible = !client.detailsVisible;
        saveData();
        renderClients();
      }
    }
    
    // Vyhledávání klientů
    function filterClients() {
      renderClients();
    }
    
    // Export dat
    function showExport() {
      const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
      document.getElementById('exportData').value = JSON.stringify(clients, null, 2);
      exportModal.show();
    }
    
    function hideExport() {
      const modalEl = document.getElementById('exportModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function importData(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (Array.isArray(importedData)) {
              clients = importedData;
              // Ujistíme se, že každý klient má property detailsVisible
              clients.forEach(client => {
                if (typeof client.detailsVisible === 'undefined') client.detailsVisible = false;
              });
              saveData();
              renderClients();
              renderSummary();
              renderTasks();
              alert('Data byla úspěšně importována.');
            } else {
              alert('Chybný formát dat.');
            }
          } catch (error) {
            alert('Chyba při importu dat.');
          }
        };
        reader.readAsText(file);
      }
    }
    
    // Editace plánu
    function editPlan(clientId, planId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          document.getElementById('editPlanName').value = plan.name;
          document.getElementById('editPlanNotes').value = plan.notes;
          document.getElementById('editPlanExpiration').value = plan.expirationDate;
          document.getElementById('editPlanCompleted').checked = plan.completed;
          document.getElementById('editPlanClientId').value = clientId;
          document.getElementById('editPlanId').value = planId;
          const modal = new bootstrap.Modal(document.getElementById('editPlanModal'));
          modal.show();
        }
      }
    }
    
    function savePlanEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editPlanClientId').value;
      const planId = document.getElementById('editPlanId').value;
      const name = document.getElementById('editPlanName').value.trim();
      const notes = document.getElementById('editPlanNotes').value.trim();
      const expiration = document.getElementById('editPlanExpiration').value;
      const completed = document.getElementById('editPlanCompleted').checked;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          plan.name = name;
          plan.notes = notes;
          plan.expirationDate = expiration;
          plan.completed = completed;
          saveData();
          renderClients();
          renderSummary();
          renderTasks();
        }
      }
      hideEditPlanModal();
    }
    
    function hideEditPlanModal() {
      const modalEl = document.getElementById('editPlanModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    // Editace kroku
    function editStep(clientId, planId, stepId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            document.getElementById('editStepDescription').value = step.description;
            document.getElementById('editStepDate').value = step.date;
            document.getElementById('editStepCompleted').checked = step.completed;
            document.getElementById('editStepClientId').value = clientId;
            document.getElementById('editStepPlanId').value = planId;
            document.getElementById('editStepId').value = stepId;
            const modal = new bootstrap.Modal(document.getElementById('editStepModal'));
            modal.show();
          }
        }
      }
    }
    
    function saveStepEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editStepClientId').value;
      const planId = document.getElementById('editStepPlanId').value;
      const stepId = document.getElementById('editStepId').value;
      const description = document.getElementById('editStepDescription').value.trim();
      const date = document.getElementById('editStepDate').value;
      const completed = document.getElementById('editStepCompleted').checked;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        const plan = client.plans.find(p => p.id === planId);
        if (plan) {
          const step = plan.steps.find(s => s.id === stepId);
          if (step) {
            step.description = description;
            step.date = date;
            step.completed = completed;
            saveData();
            renderClients();
            renderSummary();
            renderTasks();
          }
        }
      }
      hideEditStepModal();
    }
    
    function hideEditStepModal() {
      const modalEl = document.getElementById('editStepModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    // Editace smlouvy
    function editContract(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) {
        document.getElementById('editContractClientId').value = clientId;
        document.getElementById('editContractStart').value = client.contractStart || "";
        document.getElementById('editContractExpiration').value = client.contractExpiration || "";
        const modal = new bootstrap.Modal(document.getElementById('editContractModal'));
        modal.show();
      }
    }
    
    function saveContractEdits(event) {
      event.preventDefault();
      const clientId = document.getElementById('editContractClientId').value;
      const start = document.getElementById('editContractStart').value;
      const expiration = document.getElementById('editContractExpiration').value;
      const client = clients.find(c => c.id === clientId);
      if (client) {
        client.contractStart = start;
        client.contractExpiration = expiration;
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
      hideEditContractModal();
    }
    
    function hideEditContractModal() {
      const modalEl = document.getElementById('editContractModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    // Nastavení modulu
    function loadSettings() {
      const saved = localStorage.getItem('ipHlidacSettings');
      if (saved) {
        settings = JSON.parse(saved);
      } else {
        settings = Object.assign({}, defaultSettings);
      }
    }
    
    function saveSettings() {
      localStorage.setItem('ipHlidacSettings', JSON.stringify(settings));
    }
    
    function showSettings() {
      // Naplníme formulář aktuálními hodnotami
      document.getElementById('settingsEvalThreshold').value = settings.evalThreshold;
      document.getElementById('settingsPlanThreshold').value = settings.planThreshold;
      document.getElementById('settingsStepThreshold').value = settings.stepThreshold;
      document.getElementById('settingsContractThreshold').value = settings.contractThreshold;
      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
    }
    
    function hideSettings() {
      const modalEl = document.getElementById('settingsModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
    
    function saveSettingsForm(event) {
      event.preventDefault();
      settings.evalThreshold = parseInt(document.getElementById('settingsEvalThreshold').value, 10);
      settings.planThreshold = parseInt(document.getElementById('settingsPlanThreshold').value, 10);
      settings.stepThreshold = parseInt(document.getElementById('settingsStepThreshold').value, 10);
      settings.contractThreshold = parseInt(document.getElementById('settingsContractThreshold').value, 10);
      saveSettings();
      hideSettings();
      renderSummary();
      renderTasks();
    }
    
    // Vyčistit hotové položky – smaže všechny hotové plány a hotové kroky (s potvrzením)
    function clearCompleted() {
      if (confirm("Opravdu chceš odstranit všechny hotové položky? Tato akce je nevratná.")) {
        clients.forEach(client => {
          // U plánu smažeme ten, který je hotový; u zbývajících plánů smažeme hotové kroky
          client.plans = client.plans.filter(plan => {
            if (plan.completed) return false;
            plan.steps = plan.steps.filter(step => !step.completed);
            return true;
          });
        });
        saveData();
        renderClients();
        renderSummary();
        renderTasks();
      }
    }
    
    // Resetovat všechna data
    function resetData() {
      if (confirm("Opravdu chceš smazat VŠECHNA data? Tato akce je nevratná.")) {
        localStorage.removeItem('ipHlidacData');
        localStorage.removeItem('ipHlidacSettings');
        location.reload();
      }
    }
    
    /* TMAVÝ REŽIM */
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'true' : 'false');
    }
    
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
      }
    }
     if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('Service Worker registrován'))
        .catch(err => console.error('Chyba při registraci Service Workeru:', err));
    }
  </script>
</body>
</html>
